import { NextRequest, NextResponse } from "next/server";
import { join } from "path";
import { nanoid } from "nanoid";
import { auth } from "@/auth";
import { processImage } from "@/lib/image-processor";
// è§†é¢‘å¤„ç†å™¨ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œé¿å… FFmpeg åŠ è½½é—®é¢˜
import { ensureTherapistFolder, getTherapistFolderPaths } from "@/lib/folder-manager";
import prisma from "@/lib/prisma";

// æ–‡ä»¶å¤§å°é™åˆ¶
const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB
const MAX_VIDEO_SIZE = 100 * 1024 * 1024; // 100MB (å‹ç¼©å‰)

const ALLOWED_IMAGE_TYPES = ["image/jpeg", "image/jpg", "image/png", "image/webp"];
const ALLOWED_VIDEO_TYPES = ["video/mp4", "video/quicktime", "video/x-msvideo", "video/avi"];

export async function POST(request: NextRequest) {
  try {
    // éªŒè¯ç”¨æˆ·èº«ä»½
    const session = await auth();
    
    if (!session || !session.user) {
      return NextResponse.json(
        { success: false, error: "è¯·å…ˆç™»å½•" },
        { status: 401 }
      );
    }

    const formData = await request.formData();
    const file = formData.get("file") as File;
    const type = formData.get("type") as string; // avatars | therapist-photos | therapist-videos | evidence

    // éªŒè¯ä¸Šä¼ æƒé™
    if (type === "therapist-photos" || type === "therapist-videos") {
      if (session.user.role !== "therapist") {
        return NextResponse.json(
          { success: false, error: "æ— æƒé™ä¸Šä¼ æŠ€å¸ˆç…§ç‰‡" },
          { status: 403 }
        );
      }
    } else if (type === "evidence") {
      if (session.user.role !== "admin") {
        return NextResponse.json(
          { success: false, error: "æ— æƒé™ä¸Šä¼ å‡­è¯" },
          { status: 403 }
        );
      }
    }

    if (!file) {
      return NextResponse.json(
        { error: "æœªé€‰æ‹©æ–‡ä»¶" },
        { status: 400 }
      );
    }

    // éªŒè¯æ–‡ä»¶ç±»å‹
    const isImage = ALLOWED_IMAGE_TYPES.includes(file.type);
    const isVideo = ALLOWED_VIDEO_TYPES.includes(file.type);

    if (!isImage && !isVideo) {
      return NextResponse.json(
        { error: "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹" },
        { status: 400 }
      );
    }

    // éªŒè¯æ–‡ä»¶å¤§å°
    const maxSize = isImage ? MAX_IMAGE_SIZE : MAX_VIDEO_SIZE;
    if (file.size > maxSize) {
      return NextResponse.json(
        { error: `æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${maxSize / 1024 / 1024}MB` },
        { status: 400 }
      );
    }

    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶ååŸºç¡€
    const timestamp = Date.now();
    const randomId = nanoid(10);
    const baseFileName = `${timestamp}-${randomId}`;
    const fileExtension = file.name.split(".").pop() || "";
    
    let uploadDir: string;
    let folderName: string = "";
    
    // ä¸ºæŠ€å¸ˆç…§ç‰‡å’Œè§†é¢‘åˆ›å»ºä¸“å±æ–‡ä»¶å¤¹
    if (type === "therapist-photos" || type === "therapist-videos") {
      // è·å–æŠ€å¸ˆä¿¡æ¯
      const therapist = await prisma.therapist.findUnique({
        where: { id: session.user.id },
        select: { id: true, nickname: true },
      });
      
      if (!therapist) {
        return NextResponse.json(
          { success: false, error: "æŠ€å¸ˆä¿¡æ¯ä¸å­˜åœ¨" },
          { status: 404 }
        );
      }
      
      // ç¡®ä¿æŠ€å¸ˆä¸“å±æ–‡ä»¶å¤¹å­˜åœ¨
      const baseUploadDir = join(process.cwd(), "public", "uploads", type);
      folderName = await ensureTherapistFolder(baseUploadDir, therapist.id, therapist.nickname);
      uploadDir = join(baseUploadDir, folderName);
    } else {
      // å…¶ä»–ç±»å‹æ–‡ä»¶ä½¿ç”¨åŸæœ‰é€»è¾‘
      uploadDir = join(
        process.cwd(),
        "public",
        "uploads",
        type || (isImage ? "avatars" : "therapist-videos")
      );
    }

    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);

    if (isImage) {
      // å¤„ç†å›¾ç‰‡: ç”Ÿæˆå¤šä¸ªå°ºå¯¸
      console.log(`ğŸ“¸ å¼€å§‹å¤„ç†å›¾ç‰‡: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
      
      const { thumbnailUrl, mediumUrl, largeUrl } = await processImage(
        buffer,
        uploadDir,
        baseFileName
      );

      // æ„å»ºæ­£ç¡®çš„URLè·¯å¾„
      const basePath = folderName 
        ? `/uploads/${type}/${folderName}` 
        : `/uploads/${type || "avatars"}`;
      
      console.log(`âœ… å›¾ç‰‡å¤„ç†å®Œæˆ: ç¼©ç•¥å›¾=${thumbnailUrl}, ä¸­ç­‰=${mediumUrl}, åŸå›¾=${largeUrl}`);

      return NextResponse.json({
        success: true,
        url: `${basePath}/${largeUrl}`, // ä¸»URLæŒ‡å‘å¤§å›¾
        thumbnailUrl: `${basePath}/${thumbnailUrl}`,
        mediumUrl: `${basePath}/${mediumUrl}`,
        largeUrl: `${basePath}/${largeUrl}`,
        fileName: largeUrl,
        fileSize: file.size,
        fileType: "image",
      });
    } else {
      // å¤„ç†è§†é¢‘: åŠ¨æ€å¯¼å…¥è§†é¢‘å¤„ç†å™¨
      console.log(`ğŸ¬ å¼€å§‹å¤„ç†è§†é¢‘: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
      
      try {
        // åŠ¨æ€å¯¼å…¥è§†é¢‘å¤„ç†æ¨¡å—ï¼Œåªåœ¨éœ€è¦æ—¶åŠ è½½
        const { processVideo } = await import("@/lib/video-processor");
        
        const { videoUrl, coverUrl, duration } = await processVideo(
          buffer,
          uploadDir,
          baseFileName,
          fileExtension
        );

        // æ„å»ºæ­£ç¡®çš„URLè·¯å¾„
        const basePath = folderName 
          ? `/uploads/${type}/${folderName}` 
          : `/uploads/${type || "therapist-videos"}`;
        
        console.log(`âœ… è§†é¢‘å¤„ç†å®Œæˆ: è§†é¢‘=${videoUrl}, å°é¢=${coverUrl}, æ—¶é•¿=${duration}s`);

        return NextResponse.json({
          success: true,
          url: `${basePath}/${videoUrl}`,
          videoUrl: `${basePath}/${videoUrl}`,
          coverUrl: `${basePath}/${coverUrl}`,
          duration,
          fileName: videoUrl,
          fileSize: file.size,
          fileType: "video",
        });
      } catch (videoError) {
        console.error("è§†é¢‘å¤„ç†å¤±è´¥:", videoError);
        return NextResponse.json(
          { 
            success: false, 
            error: "è§†é¢‘å¤„ç†åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜" 
          },
          { status: 500 }
        );
      }
    }
  } catch (error) {
    console.error("æ–‡ä»¶ä¸Šä¼ é”™è¯¯:", error);
    return NextResponse.json(
      { error: "æ–‡ä»¶ä¸Šä¼ å¤±è´¥" },
      { status: 500 }
    );
  }
}

