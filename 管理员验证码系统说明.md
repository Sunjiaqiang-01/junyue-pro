# 🔐 管理员注册验证码系统

## 系统概述

**所有技师注册必须使用管理员生成的验证码**，完全控制技师准入。

---

## ✅ 已完成的改造

### 1. 数据库变更

#### 删除的字段（Therapist表）

- ❌ `inviteCode` - 技师邀请码（已删除）
- ❌ `invitedBy` - 邀请人（已删除）

#### 新增字段（Therapist表）

- ✅ `registrationCodeId` - 关联的注册验证码ID

#### 新增表（RegistrationCode）

```sql
CREATE TABLE registration_codes (
  id TEXT PRIMARY KEY,
  code TEXT UNIQUE,           -- 6位数字验证码
  codeType RegistrationCodeType DEFAULT 'LIMITED',
  maxUses INTEGER DEFAULT 1,  -- 最大使用次数
  currentUses INTEGER DEFAULT 0,
  expiresAt TIMESTAMP,        -- 过期时间
  isActive BOOLEAN DEFAULT true,
  note TEXT,                  -- 备注
  createdBy TEXT NOT NULL,    -- 管理员ID
  createdAt TIMESTAMP,
  updatedAt TIMESTAMP
);
```

#### 新增枚举

```typescript
enum RegistrationCodeType {
  ONETIME     // 一次性（注册1人后失效）
  LIMITED     // 限次数（可设置次数）
  UNLIMITED   // 无限次数（仅受时效限制）
}
```

---

### 2. 验证码类型

| 类型          | 说明     | 使用场景         | 示例                 |
| ------------- | -------- | ---------------- | -------------------- |
| **ONETIME**   | 一次性   | 精准招募特定技师 | 面试后发放，用完即废 |
| **LIMITED**   | 限次数   | 小批量招募       | 线下活动，10人限额   |
| **UNLIMITED** | 无限次数 | 长期招募渠道     | 合作机构专用码       |

---

### 3. API接口

#### 管理员接口

**生成验证码**

```http
POST /api/admin/registration-codes/generate
Authorization: Bearer <admin_token>

{
  "count": 10,                    // 生成数量（1-1000）
  "codeType": "ONETIME",          // 类型
  "maxUses": 1,                   // 最大使用次数
  "expiresInDays": 7,             // 有效天数（-1为永久）
  "note": "春节招募活动"          // 备注
}
```

**获取验证码列表**

```http
GET /api/admin/registration-codes/list?page=1&pageSize=20&status=active
```

参数：

- `status`: `all`, `active`, `used`, `expired`
- `codeType`: `ONETIME`, `LIMITED`, `UNLIMITED`

#### 技师接口

**注册**（已修改）

```http
POST /api/therapist/auth/register

{
  "username": "testuser",
  "password": "123456",
  "email": "test@qq.com",
  "registrationCode": "858860"  // 6位数字验证码
}
```

---

## 🎯 使用流程

### 管理员操作

#### 方式1：API生成（推荐）

```bash
# 使用管理员token调用API
curl -X POST http://localhost:3000/api/admin/registration-codes/generate \
  -H "Cookie: auth-token=xxx" \
  -d '{
    "count": 50,
    "codeType": "ONETIME",
    "maxUses": 1,
    "expiresInDays": 7,
    "note": "2025年1月批次"
  }'
```

#### 方式2：脚本生成（测试用）

```bash
# 生成10个测试验证码
npx tsx scripts/generate-initial-codes.ts
```

#### 方式3：后台UI（待开发）

- 可视化界面
- 批量生成
- 导出Excel
- 使用统计

---

### 技师操作

1. **获取验证码**
   - 联系管理员
   - 线下活动领取
   - 合作机构分发

2. **注册账号**
   - 访问 `/therapist`
   - 点击"立即注册"
   - 填写信息 + 6位验证码
   - 提交注册

3. **验证码状态**
   - ✅ 有效：可以注册
   - ❌ 已用完：提示"已达到最大使用次数"
   - ❌ 已过期：提示"验证码已过期"
   - ❌ 已禁用：提示"验证码已被禁用"

---

## 📊 测试验证码

已为您生成10个测试验证码（7天有效）：

```
858860
388558
775407
560970
997783
300491
709411
310391
522359
767078
```

**使用方式**：

1. 访问 `http://localhost:3000/therapist`
2. 点击"立即注册"
3. 输入任意验证码（如：`858860`）
4. 完成注册

**注意**：每个验证码只能使用1次！

---

## 🔒 安全特性

### 1. 防暴力破解

- 6位数字 = 100万种组合
- 配合频率限制（已实现）
- 配合尝试次数限制（已实现）
- 时效性控制（新增）

### 2. 可追溯性

- 每个技师关联验证码ID
- 可查询哪个验证码注册了哪些技师
- 可查询验证码使用情况

### 3. 灵活控制

- 随时禁用验证码
- 调整有效期
- 批量管理

---

## 📈 统计功能

### 验证码统计

```typescript
{
  total: 100,      // 总数
  active: 80,      // 启用的
  used: 45,        // 已使用的
  expired: 20,     // 已过期的
  unused: 55       // 未使用的
}
```

### 使用情况

- 每个验证码的使用次数
- 哪些技师使用了该验证码
- 注册时间分布
- 来源渠道分析

---

## 🛠️ 管理操作

### 查询验证码

```sql
-- 查看所有有效验证码
SELECT * FROM registration_codes
WHERE isActive = true
AND (expiresAt IS NULL OR expiresAt > NOW())
ORDER BY createdAt DESC;

-- 查看某个验证码的使用情况
SELECT rc.code, rc.maxUses, rc.currentUses,
       t.username, t.email, t.createdAt
FROM registration_codes rc
LEFT JOIN therapists t ON t.registrationCodeId = rc.id
WHERE rc.code = '858860';
```

### 禁用验证码

```sql
UPDATE registration_codes
SET isActive = false
WHERE code = '858860';
```

### 延长有效期

```sql
UPDATE registration_codes
SET expiresAt = NOW() + INTERVAL '30 days'
WHERE code = '858860';
```

---

## 🎨 管理后台设计（待开发）

### 页面1：生成验证码

```
┌─────────────────────────────────────┐
│  📝 生成注册验证码                    │
├─────────────────────────────────────┤
│  类型: [一次性 ▼]                     │
│  数量: [10        ]                   │
│  有效期: [7天 ▼]                      │
│  备注: [春节招募活动]                  │
│                                       │
│  [生成验证码] [批量导出]              │
└─────────────────────────────────────┘
```

### 页面2：验证码列表

```
┌───────────────────────────────────────────────┐
│  🎫 验证码管理                                 │
├───────────────────────────────────────────────┤
│  筛选: [全部▼] [一次性▼] [搜索...]            │
├───┬────────┬──────┬──────┬──────┬──────┬────┤
│ # │ 验证码  │ 类型  │ 使用  │ 过期  │ 状态  │ 操作│
├───┼────────┼──────┼──────┼──────┼──────┼────┤
│ 1 │ 858860 │一次性│ 0/1  │7天后 │启用  │禁用│
│ 2 │ 388558 │一次性│ 1/1  │7天后 │已用  │详情│
│...│        │      │      │      │      │    │
└───┴────────┴──────┴──────┴──────┴──────┴────┘
```

### 页面3：使用统计

```
┌─────────────────────────────────────┐
│  📊 使用统计                          │
├─────────────────────────────────────┤
│  总验证码: 100                        │
│  已使用: 45 (45%)                     │
│  未使用: 55 (55%)                     │
│  已过期: 20                           │
│                                       │
│  本月新增技师: 23                     │
│  来源Top3:                            │
│   1. 线下活动: 12人                   │
│   2. 合作机构: 8人                    │
│   3. 内部推荐: 3人                    │
└─────────────────────────────────────┘
```

---

## 💡 运营建议

### 短期（1个月）

1. **手动发放**
   - 面试后发放一次性验证码
   - 微信私发，避免泄露

2. **小批量测试**
   - 每批10-20个验证码
   - 观察注册转化率

3. **记录来源**
   - 备注字段记录渠道
   - 分析哪个渠道效果好

### 中期（3个月）

1. **渠道分组**
   - 线下活动专用码
   - 合作机构专用码
   - VIP推荐专用码

2. **自动化**
   - 开发管理后台
   - 批量生成导出
   - 数据可视化

3. **优化策略**
   - 根据数据调整有效期
   - 热门渠道增加配额

### 长期（6个月+）

1. **精细化运营**
   - A/B测试不同类型
   - 动态调整策略
   - 预测注册需求

2. **质量控制**
   - 分析不同来源质量
   - 优化高质量渠道
   - 淘汰低质量渠道

---

## 🔄 迁移说明

### 从旧系统迁移

**旧系统（技师邀请制）：**

- 技师A注册 → 获得邀请码 → 邀请技师B

**新系统（管理员控制）：**

- 管理员生成验证码 → 发放给技师 → 技师注册

**数据处理：**

- ✅ 现有10个技师的 `inviteCode` 和 `invitedBy` 已删除
- ✅ 新注册的技师使用 `registrationCodeId` 关联
- ✅ 历史数据保留在技师表中

---

## ❓ 常见问题

### Q1：为什么要6位数字？

**A**：

- ✅ 易记忆（比UUID友好）
- ✅ 易输入（纯数字）
- ✅ 足够安全（100万种组合+时效+限次）

### Q2：验证码会重复吗？

**A**：

- 不会，数据库唯一约束
- 生成时自动避免弱密码（000000、123456等）
- 生成时检查重复

### Q3：如何批量发放验证码？

**A**：

1. 管理员后台生成
2. 导出为Excel
3. 线下活动打印二维码
4. 或微信群批量发送

### Q4：技师丢失验证码怎么办？

**A**：

- 如果验证码未使用：重新告知
- 如果验证码已使用：生成新的
- 如果验证码过期：生成新的

### Q5：如何防止验证码泄露？

**A**：

- 设置短有效期（1-7天）
- 使用一次性验证码
- 私密渠道发放
- 定期更换批次

---

**系统已完成，可以开始测试！** 🎉
