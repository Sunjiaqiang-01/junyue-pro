// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== æŠ€å¸ˆç›¸å…³è¡¨ (5å¼ ) ====================

// 1. æŠ€å¸ˆè¡¨
model Therapist {
  id                  String            @id @default(cuid())
  username            String            @unique // ğŸ†• ç”¨æˆ·åç™»å½•
  password            String
  email               String?           // ğŸ†• é‚®ç®±ï¼ˆæ‰¾å›å¯†ç ç”¨ï¼‰
  phone               String?           // æ”¹ä¸ºå¯é€‰
  nickname            String
  
  age                 Int
  height              Int
  weight              Int
  cardValue           String?           // ğŸ†• ç‰Œå€¼ï¼Œä¾‹å¦‚ "17cm"
  city                String
  areas               String[]
  location            Json?             // ğŸ†• ä½ç½®ä¿¡æ¯ {name, street, latitude, longitude}
  
  status              TherapistStatus   @default(PENDING)
  auditReason         String?
  
  isOnline            Boolean           @default(false)
  lastOnlineAt        DateTime?
  
  isNew               Boolean           @default(true)
  isFeatured          Boolean           @default(false)
  viewCount           Int               @default(0) // ğŸ†• æµè§ˆé‡ç»Ÿè®¡
  
  // æ³¨å†ŒéªŒè¯ç ï¼ˆç®¡ç†å‘˜ç”Ÿæˆï¼‰
  registrationCodeId  String?
  registrationCode    RegistrationCode? @relation(fields: [registrationCodeId], references: [id])
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  auditedAt           DateTime?
  
  profile             TherapistProfile?
  photos              TherapistPhoto[]
  videos              TherapistVideo[]
  schedules           TherapistSchedule[]
  notifications       Notification[]
  deactivationRequests TherapistDeactivationRequest[]
  views               TherapistView[]
  
  @@index([username])
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([city])
  @@index([isOnline])
  @@index([createdAt])
  @@map("therapists")
}

enum TherapistStatus {
  PENDING   // å¾…å®¡æ ¸
  APPROVED  // å·²é€šè¿‡
  REJECTED  // å·²æ‹’ç»
  BANNED    // å·²å°ç¦
}

// 2. æŠ€å¸ˆèµ„æ–™è¡¨
model TherapistProfile {
  id              String        @id @default(cuid())
  therapistId     String        @unique
  therapist       Therapist     @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  introduction    String        @db.Text
  specialties     String[]
  
  serviceType     ServiceType[]
  serviceAddress  String?
  serviceLat      Decimal?      @db.Decimal(10, 7)
  serviceLng      Decimal?      @db.Decimal(10, 7)
  serviceRadius   Int?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([therapistId])
  @@map("therapist_profiles")
}

enum ServiceType {
  VISIT_CLIENT  // ä¸Šé—¨æœåŠ¡
  CLIENT_VISIT  // å®¢æˆ·åˆ°åº—
  NEGOTIATE     // åŒæ–¹åå•†
}

// 3. æŠ€å¸ˆç…§ç‰‡è¡¨
model TherapistPhoto {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  // åŸURL (ä¿æŒå…¼å®¹,æŒ‡å‘large)
  url         String
  
  // å¤šå°ºå¯¸URLs (å›¾ç‰‡ä¸“ç”¨)
  thumbnailUrl String?  // ç¼©ç•¥å›¾ 200x200
  mediumUrl    String?  // ä¸­ç­‰å°ºå¯¸ 800x800
  largeUrl     String?  // åŸå›¾ 1200x1200
  
  // è§†é¢‘å­—æ®µ
  isVideo      Boolean  @default(false)  // æ˜¯å¦ä¸ºè§†é¢‘
  videoUrl     String?  // è§†é¢‘URL
  coverUrl     String?  // è§†é¢‘å°é¢
  duration     Int?     // è§†é¢‘æ—¶é•¿(ç§’)
  
  order        Int      @default(0)
  isPrimary    Boolean  @default(false)  // æ˜¯å¦ä¸ºä¸»å›¾
  
  createdAt    DateTime @default(now())
  
  @@index([therapistId])
  @@index([therapistId, isPrimary])
  @@index([order])
  @@map("therapist_photos")
}

// 4. æŠ€å¸ˆè§†é¢‘è¡¨
model TherapistVideo {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  url         String
  coverUrl    String?
  duration    Int?
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
  @@map("therapist_videos")
}

// 5. æŠ€å¸ˆæ—¶é—´è¡¨ï¼ˆå¯é€‰ä¿ç•™ï¼‰
model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  date        DateTime  @db.Date
  startTime   String
  endTime     String
  
  isAvailable Boolean   @default(true)
  isRecurring Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([therapistId, date, startTime])
  @@index([therapistId])
  @@index([date])
  @@map("therapist_schedules")
}

// ==================== æœåŠ¡ç›¸å…³è¡¨ (2å¼ ) ====================

// 6. åŸå¸‚è¡¨
model City {
  id        String    @id @default(cuid())
  name      String    @unique
  code      String    @unique
  
  isActive  Boolean   @default(true)
  order     Int       @default(0)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  areas     Area[]
  
  @@index([isActive])
  @@index([order])
  @@map("cities")
}

// 7. åŒºåŸŸè¡¨
model Area {
  id        String    @id @default(cuid())
  cityId    String
  city      City      @relation(fields: [cityId], references: [id])
  name      String
  code      String
  
  isActive  Boolean   @default(true)
  order     Int       @default(0)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@unique([cityId, name])
  @@index([cityId])
  @@index([isActive])
  @@map("areas")
}

// ==================== ç³»ç»Ÿç›¸å…³è¡¨ (4å¼ ) ====================

// 8. ç®¡ç†å‘˜è¡¨
model Admin {
  id          String      @id @default(cuid())
  username    String      @unique
  password    String
  name        String
  
  role        AdminRole   @default(ADMIN)
  
  lastLoginAt DateTime?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([username])
  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN  // è¶…çº§ç®¡ç†å‘˜
  ADMIN        // ç®¡ç†å‘˜
  OPERATOR     // è¿è¥
}

// 10. å¿…çœ‹æ”»ç•¥å†…å®¹è¡¨
model GuideContent {
  id        String   @id @default(cuid())
  title     String   @default("å¿…çœ‹æ”»ç•¥")
  content   String   @db.Text  // Markdownæ ¼å¼å†…å®¹
  order     Int      @default(1)
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([isActive])
  @@index([order])
  @@map("guide_contents")
}

// 9. é€šçŸ¥æ¶ˆæ¯è¡¨
model Notification {
  id          String           @id @default(cuid())
  
  therapistId String?
  therapist   Therapist?       @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  content     String           @db.Text
  
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
  
  @@index([therapistId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM      // ç³»ç»Ÿé€šçŸ¥
  AUDIT       // å®¡æ ¸é€šçŸ¥
  ANNOUNCEMENT // å…¬å‘Šé€šçŸ¥
}

// 10. å…¬å‘Šè¡¨
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  
  type        AnnouncementType @default(NOTICE)
  
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  
  isActive    Boolean   @default(true)  // æ˜¯å¦æ¿€æ´»æ˜¾ç¤º
  sortOrder   Int       @default(0)     // æ’åºé¡ºåº
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([type])
  @@index([isPublished])
  @@index([publishedAt])
  @@index([isActive])
  @@index([sortOrder])
  @@map("announcements")
}

enum AnnouncementType {
  NOTICE      // é€šçŸ¥
  ACTIVITY    // æ´»åŠ¨
  MAINTENANCE // ç»´æŠ¤
}

// 11. å®¢æœé…ç½®è¡¨
model CustomerService {
  id              String   @id @default(cuid())
  wechatQrCode    String   // å®¢æœå¾®ä¿¡äºŒç»´ç URL
  wechatId        String?  // å®¢æœå¾®ä¿¡å·
  phone           String?  // å®¢æœç”µè¯
  workingHours    String   // å·¥ä½œæ—¶é—´ï¼ˆå¦‚ï¼š9:00-22:00ï¼‰
  
  isActive        Boolean  @default(true)
  order           Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive])
  @@map("customer_services")
}

// 12. éªŒè¯ç è¡¨
model VerificationCode {
  id          String   @id @default(cuid())
  email       String   // é‚®ç®±åœ°å€
  code        String   // 6ä½éªŒè¯ç 
  type        CodeType @default(RESET_PASSWORD) // éªŒè¯ç ç±»å‹
  
  expiresAt   DateTime // è¿‡æœŸæ—¶é—´
  usedAt      DateTime? // ä½¿ç”¨æ—¶é—´
  
  createdAt   DateTime @default(now())
  
  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@map("verification_codes")
}

enum CodeType {
  RESET_PASSWORD  // é‡ç½®å¯†ç 
  EMAIL_VERIFY    // é‚®ç®±éªŒè¯
}

// 13. å®‰å…¨æ—¥å¿—è¡¨ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
model SecurityLog {
  id          String      @id @default(cuid())
  email       String      // é‚®ç®±æˆ–ç”¨æˆ·æ ‡è¯†
  action      SecurityAction // æ“ä½œç±»å‹
  success     Boolean     // æ˜¯å¦æˆåŠŸ
  ipAddress   String?     // IPåœ°å€
  userAgent   String?     // ç”¨æˆ·ä»£ç†
  
  createdAt   DateTime    @default(now())
  
  @@index([email, action, createdAt])
  @@index([ipAddress, createdAt])
  @@map("security_logs")
}

enum SecurityAction {
  CODE_VERIFY       // éªŒè¯ç éªŒè¯
  PASSWORD_RESET    // å¯†ç é‡ç½®
  LOGIN_ATTEMPT     // ç™»å½•å°è¯•
  USERNAME_CHECK    // ç”¨æˆ·åæ£€æŸ¥
}

// 14. æ³¨å†ŒéªŒè¯ç è¡¨ï¼ˆç®¡ç†å‘˜ç”Ÿæˆï¼‰
model RegistrationCode {
  id          String    @id @default(cuid())
  code        String    @unique // 6ä½æ•°å­—éªŒè¯ç 
  
  // ç±»å‹
  codeType    RegistrationCodeType @default(LIMITED)
  
  // ä½¿ç”¨é™åˆ¶
  maxUses     Int       @default(1) // æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºæ— é™ï¼‰
  currentUses Int       @default(0) // å½“å‰å·²ä½¿ç”¨æ¬¡æ•°
  
  // æ—¶æ•ˆæ€§
  expiresAt   DateTime? // è¿‡æœŸæ—¶é—´ï¼ˆnullè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼‰
  
  // çŠ¶æ€
  isActive    Boolean   @default(true) // æ˜¯å¦å¯ç”¨
  
  // å¤‡æ³¨ä¿¡æ¯
  note        String?   // å¤‡æ³¨ï¼ˆå¦‚ï¼šæ˜¥èŠ‚æ‹›å‹Ÿæ‰¹æ¬¡ï¼‰
  
  // åˆ›å»ºè€…
  createdBy   String    // ç®¡ç†å‘˜ID
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ä½¿ç”¨è¯¥éªŒè¯ç æ³¨å†Œçš„æŠ€å¸ˆ
  therapists  Therapist[]
  
  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
  @@map("registration_codes")
}

enum RegistrationCodeType {
  ONETIME     // ä¸€æ¬¡æ€§ï¼ˆä½¿ç”¨1æ¬¡åå¤±æ•ˆï¼‰
  LIMITED     // é™æ¬¡æ•°ï¼ˆå¯è®¾ç½®ä½¿ç”¨æ¬¡æ•°ï¼‰
  UNLIMITED   // æ— é™æ¬¡æ•°ï¼ˆä»…å—æ—¶æ•ˆé™åˆ¶ï¼‰
}

// 15. æŠ€å¸ˆæ³¨é”€ç”³è¯·è¡¨
model TherapistDeactivationRequest {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  status      DeactivationStatus @default(PENDING)
  
  // å®¡æ ¸ç›¸å…³
  reviewerId  String?   // å®¡æ ¸ç®¡ç†å‘˜ID
  reviewNote  String?   // å®¡æ ¸æ„è§
  reviewedAt  DateTime? // å®¡æ ¸æ—¶é—´
  
  // æ—¶é—´èŠ‚ç‚¹
  requestedAt DateTime  @default(now()) // ç”³è¯·æ—¶é—´
  executedAt  DateTime? // å®é™…æ³¨é”€æ—¶é—´
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([therapistId])
  @@index([status])
  @@index([requestedAt])
  @@map("therapist_deactivation_requests")
}

enum DeactivationStatus {
  PENDING   // å¾…å®¡æ ¸
  APPROVED  // å·²é€šè¿‡
  REJECTED  // å·²æ‹’ç»
  CANCELLED // å·²æ’¤é”€
}

// ==================== è®¿é—®ç»Ÿè®¡è¡¨ (2å¼ ) ====================

// 16. ç½‘ç«™è®¿é—®ç»Ÿè®¡è¡¨
model SiteVisit {
  id        String   @id @default(cuid())
  ip        String   // è®¿é—®è€…IP
  userAgent String?  // ç”¨æˆ·ä»£ç†
  page      String   // è®¿é—®é¡µé¢
  referrer  String?  // æ¥æºé¡µé¢
  
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@index([page])
  @@map("site_visits")
}

// 17. æŠ€å¸ˆæµè§ˆç»Ÿè®¡è¡¨
model TherapistView {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  ip          String    // è®¿é—®è€…IP
  userAgent   String?   // ç”¨æˆ·ä»£ç†
  referrer    String?   // æ¥æºé¡µé¢
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
  @@index([createdAt])
  @@map("therapist_views")
}