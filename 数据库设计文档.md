# 君悦SPA - 数据库设计文档

> **版本**: v2.0  
> **创建日期**: 2025-10-11  
> **数据库**: PostgreSQL 16  
> **ORM**: Prisma  
> **编码**: UTF-8

---

## 📋 目录

- [数据库概述](#数据库概述)
- [核心表结构](#核心表结构)
- [表关系图](#表关系图)
- [索引设计](#索引设计)

---

## 📊 数据库概述

### 设计原则

1. **简化优先**: 删除不必要的表，保留核心功能
2. **性能优化**: 合理设计索引，优化查询性能
3. **安全性**: 敏感信息加密存储
4. **扩展性**: 预留字段，支持业务扩展

### 数据表分类

- **技师相关**: 5张表
- **服务相关**: 2张表
- **系统相关**: 4张表

**总计**: 11张核心数据表

---

## 🗄️ 核心表结构

### 一、技师相关表 (5张)

#### 1.1 therapists - 技师表

```prisma
model Therapist {
  id                  String            @id @default(cuid())
  phone               String            @unique
  password            String            // bcrypt加密
  nickname            String

  // 基本信息
  age                 Int
  height              Int               // 身高(cm)
  weight              Int               // 体重(kg)
  cardValue           String?           // 🆕 牌值(例如："17cm")
  city                String
  areas               String[]          // 服务区域(数组)
  location            Json?             // 🆕 位置信息 {name, street, latitude, longitude}

  // 审核状态
  status              TherapistStatus   @default(PENDING)
  auditReason         String?           // 审核不通过原因

  // 在线状态
  isOnline            Boolean           @default(false)
  lastOnlineAt        DateTime?

  // 标签
  isNew               Boolean           @default(true)   // 新技师(注册30天内)
  isFeatured          Boolean           @default(false)  // 推荐技师

  // 邀请码(可选)
  inviteCode          String            @unique
  invitedBy           String?
  inviter             Therapist?        @relation("TherapistInvitations", fields: [invitedBy], references: [inviteCode])
  invitees            Therapist[]       @relation("TherapistInvitations")

  // 时间戳
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  auditedAt           DateTime?

  // 关联
  profile             TherapistProfile?
  photos              TherapistPhoto[]
  videos              TherapistVideo[]
  schedules           TherapistSchedule[]
  notifications       Notification[]

  @@index([phone])
  @@index([status])
  @@index([city])
  @@index([isOnline])
  @@index([createdAt])
  @@map("therapists")
}

enum TherapistStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
  BANNED    // 已封禁
}
```

**字段说明**:

- `invitedBy`: 邀请人邀请码（可选，非必填）
- `isNew`: 注册30天内自动标记为新技师
- `isFeatured`: 管理员手动设置推荐技师

---

#### 1.2 therapist_profiles - 技师资料表

```prisma
model TherapistProfile {
  id              String        @id @default(cuid())
  therapistId     String        @unique
  therapist       Therapist     @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  introduction    String        @db.Text  // 个人介绍
  specialties     String[]                // 服务特色(数组)

  // 联系方式(加密存储，仅管理端可见)
  wechat          String?
  qq              String?
  phone           String?

  // 服务信息
  serviceType     ServiceType[]           // 服务方式(数组)
  serviceAddress  String?                 // 服务地址
  serviceLat      Decimal?      @db.Decimal(10, 7)  // 纬度
  serviceLng      Decimal?      @db.Decimal(10, 7)  // 经度
  serviceRadius   Int?                    // 服务半径(km)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([therapistId])
  @@map("therapist_profiles")
}

enum ServiceType {
  VISIT_CLIENT  // 上门服务
  CLIENT_VISIT  // 客户到店
  NEGOTIATE     // 双方协商
}
```

**安全说明**:

- 联系方式字段（wechat, qq, phone）在API返回时，用户端不返回，仅管理端返回

---

#### 1.3 therapist_photos - 技师照片表

```prisma
model TherapistPhoto {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  url         String    // 图片URL
  order       Int       @default(0)  // 排序(数字越小越靠前)

  createdAt   DateTime  @default(now())

  @@index([therapistId])
  @@index([order])
  @@map("therapist_photos")
}
```

---

#### 1.4 therapist_videos - 技师视频表

```prisma
model TherapistVideo {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  url         String    // 视频URL
  coverUrl    String?   // 封面图URL
  duration    Int?      // 时长(秒)

  createdAt   DateTime  @default(now())

  @@index([therapistId])
  @@map("therapist_videos")
}
```

---

#### 1.5 therapist_schedules - 技师时间表

```prisma
model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  date        DateTime  @db.Date      // 日期
  startTime   String                  // 开始时间(HH:mm)
  endTime     String                  // 结束时间(HH:mm)

  isAvailable Boolean   @default(true)  // 是否可用
  isRecurring Boolean   @default(false) // 是否重复(每天)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([therapistId, date, startTime])
  @@index([therapistId])
  @@index([date])
  @@map("therapist_schedules")
}
```

---

### 二、服务相关表 (2张)

#### 2.1 cities - 城市表

```prisma
model City {
  id        String    @id @default(cuid())
  name      String    @unique
  code      String    @unique  // 城市代码

  isActive  Boolean   @default(true)
  order     Int       @default(0)  // 排序

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  areas     Area[]

  @@index([isActive])
  @@index([order])
  @@map("cities")
}
```

---

#### 2.2 areas - 区域表

```prisma
model Area {
  id        String    @id @default(cuid())
  cityId    String
  city      City      @relation(fields: [cityId], references: [id])
  name      String
  code      String    // 区域代码

  isActive  Boolean   @default(true)
  order     Int       @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([cityId, name])
  @@index([cityId])
  @@index([isActive])
  @@map("areas")
}
```

---

### 三、系统相关表 (4张)

#### 3.1 admins - 管理员表

```prisma
model Admin {
  id          String      @id @default(cuid())
  username    String      @unique
  password    String      // bcrypt加密
  name        String

  role        AdminRole   @default(ADMIN)

  lastLoginAt DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([username])
  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN  // 超级管理员
  ADMIN        // 管理员
  OPERATOR     // 运营
}
```

---

#### 3.2 notifications - 通知消息表

```prisma
model Notification {
  id          String           @id @default(cuid())

  therapistId String?
  therapist   Therapist?       @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  type        NotificationType
  title       String
  content     String           @db.Text

  isRead      Boolean          @default(false)
  readAt      DateTime?

  createdAt   DateTime         @default(now())

  @@index([therapistId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM       // 系统通知
  AUDIT        // 审核通知
  ANNOUNCEMENT // 公告通知
}
```

---

#### 3.3 announcements - 公告表

```prisma
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text

  type        AnnouncementType @default(NOTICE)

  isPublished Boolean   @default(false)
  publishedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
  @@index([isPublished])
  @@index([publishedAt])
  @@map("announcements")
}

enum AnnouncementType {
  NOTICE      // 通知
  ACTIVITY    // 活动
  MAINTENANCE // 维护
}
```

---

#### 3.4 customer_services - 客服配置表

```prisma
model CustomerService {
  id              String   @id @default(cuid())
  wechatQrCode    String   // 客服微信二维码URL
  wechatId        String?  // 客服微信号
  phone           String?  // 客服电话
  workingHours    String   // 工作时间(如: 9:00-22:00)

  isActive        Boolean  @default(true)
  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@map("customer_services")
}
```

---

## 🔗 表关系图

```
技师系统：
Therapist ──< TherapistProfile (一对一)
Therapist ──< TherapistPhoto (一对多)
Therapist ──< TherapistVideo (一对多)
Therapist ──< TherapistSchedule (一对多)
Therapist ──< Notification (一对多)
Therapist >── Therapist (自关联，邀请关系，可选)

服务系统：
City ──< Area (一对多)

系统：
无关联关系
```

**符号说明**：

- `──<` : 一对多
- `>──` : 多对一
- `──○` : 一对一

---

## 📇 索引设计

### 性能优化索引

```sql
-- 技师表
CREATE INDEX idx_therapists_phone ON therapists(phone);
CREATE INDEX idx_therapists_status ON therapists(status);
CREATE INDEX idx_therapists_city ON therapists(city);
CREATE INDEX idx_therapists_online ON therapists(is_online);
CREATE INDEX idx_therapists_created_at ON therapists(created_at);

-- 技师照片表
CREATE INDEX idx_therapist_photos_therapist_id ON therapist_photos(therapist_id);
CREATE INDEX idx_therapist_photos_order ON therapist_photos(order);

-- 技师时间表
CREATE INDEX idx_therapist_schedules_therapist_id ON therapist_schedules(therapist_id);
CREATE INDEX idx_therapist_schedules_date ON therapist_schedules(date);

-- 城市表
CREATE INDEX idx_cities_active ON cities(is_active);
CREATE INDEX idx_cities_order ON cities(order);

-- 区域表
CREATE INDEX idx_areas_city_id ON areas(city_id);
CREATE INDEX idx_areas_active ON areas(is_active);

-- 管理员表
CREATE INDEX idx_admins_username ON admins(username);

-- 通知表
CREATE INDEX idx_notifications_therapist_id ON notifications(therapist_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);

-- 公告表
CREATE INDEX idx_announcements_type ON announcements(type);
CREATE INDEX idx_announcements_published ON announcements(is_published);
```

---

## 🔐 安全与备份

### 敏感字段加密

- `therapists.password` - bcrypt加密
- `admins.password` - bcrypt加密
- `therapist_profiles.wechat` - 仅管理端可见
- `therapist_profiles.qq` - 仅管理端可见
- `therapist_profiles.phone` - 仅管理端可见

### 数据访问控制

**用户端API**:

- ❌ 不返回 `therapist_profiles` 的联系方式字段

**管理端API**:

- ✅ 返回完整的 `therapist_profiles` 包括联系方式

### 备份策略

- 每日全量备份: 凌晨3点
- 保留最近7天备份
- 每周备份上传到云存储

---

## 📊 数据统计需求

### 管理端数据看板SQL

```sql
-- 技师统计
SELECT
  COUNT(*) as total_therapists,
  COUNT(CASE WHEN status = 'APPROVED' THEN 1 END) as approved_therapists,
  COUNT(CASE WHEN status = 'PENDING' THEN 1 END) as pending_therapists,
  COUNT(CASE WHEN is_online = true THEN 1 END) as online_therapists,
  COUNT(CASE WHEN is_new = true THEN 1 END) as new_therapists,
  COUNT(CASE WHEN is_featured = true THEN 1 END) as featured_therapists
FROM therapists;

-- 城市分布
SELECT
  city,
  COUNT(*) as count
FROM therapists
WHERE status = 'APPROVED'
GROUP BY city
ORDER BY count DESC;

-- 今日新增
SELECT COUNT(*) as today_new
FROM therapists
WHERE DATE(created_at) = CURRENT_DATE;

-- 审核通过率
SELECT
  ROUND(
    COUNT(CASE WHEN status = 'APPROVED' THEN 1 END) * 100.0 /
    COUNT(CASE WHEN status IN ('APPROVED', 'REJECTED') THEN 1 END),
    2
  ) as approval_rate
FROM therapists
WHERE status IN ('APPROVED', 'REJECTED');
```

---

## 📝 版本历史

| 版本 | 日期       | 变更说明                           |
| ---- | ---------- | ---------------------------------- |
| v1.0 | 2025-10-08 | 初始版本，完整预约平台设计         |
| v2.0 | 2025-10-11 | 简化版本，删除用户/订单/分佣相关表 |

---

**文档结束**
