# 君悦SPA - 数据库设计文档

> **版本**: v1.0  
> **创建日期**: 2025-10-08  
> **数据库**: PostgreSQL 16  
> **ORM**: Prisma  
> **编码**: UTF-8

---

## 📋 目录

- [数据库概述](#数据库概述)
- [核心表结构](#核心表结构)
- [表关系图](#表关系图)
- [索引设计](#索引设计)
- [数据字典](#数据字典)

---

## 📊 数据库概述

### 设计原则
1. **范式化设计**: 遵循第三范式,减少数据冗余
2. **性能优化**: 合理设计索引,优化查询性能
3. **扩展性**: 预留字段,支持业务扩展
4. **数据完整性**: 外键约束,确保数据一致性
5. **安全性**: 敏感信息加密存储

### 数据表分类
- **用户相关**: 7张表
- **技师相关**: 7张表
- **订单相关**: 4张表
- **服务相关**: 3张表
- **邀请分佣**: 5张表
- **财务相关**: 4张表
- **系统相关**: 5张表

**总计**: 35张核心数据表

---

## 🗄️ 核心表结构

### 一、用户相关表 (7张)

#### 1.1 users - 用户表 (核心)

```prisma
model User {
  id                String    @id @default(cuid())
  phone             String    @unique // 手机号(唯一)
  password          String    // 密码(bcrypt加密)
  nickname          String?   // 昵称
  avatar            String?   // 头像URL
  
  // 积分相关
  formalPoints      Int       @default(0) // 正式积分(永久有效)
  tempPoints        Int       @default(0) // 临时积分(60天过期)
  tempPointsExpireAt DateTime? // 临时积分过期时间
  
  // 邀请码
  inviteCode        String    @unique // 用户邀请码(8位)
  invitedBy         String?   // 邀请人邀请码
  inviter           User?     @relation("UserInvitations", fields: [invitedBy], references: [inviteCode])
  invitees          User[]    @relation("UserInvitations")
  
  // 统计数据
  totalOrders       Int       @default(0) // 总订单数
  totalSpent        Decimal   @default(0) @db.Decimal(10, 2) // 累计消费
  totalEarnings     Decimal   @default(0) @db.Decimal(10, 2) // 推荐收益
  
  // 状态
  status            UserStatus @default(ACTIVE) // 账号状态
  lastLoginAt       DateTime?  // 最后登录时间
  
  // 时间戳
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // 关联
  profile           UserProfile?
  orders            Order[]
  reviews           Review[]
  favorites         Favorite[]
  pointRecords      PointRecord[]
  signInRecords     SignInRecord[]
  notifications     Notification[]
  feedbacks         Feedback[]
  unlocks           ContactUnlock[]
  
  @@index([phone])
  @@index([inviteCode])
  @@index([status])
  @@index([createdAt])
}

enum UserStatus {
  ACTIVE      // 正常
  BANNED      // 封禁
  SUSPENDED   // 暂停
}
```

#### 1.2 user_profiles - 用户资料扩展表

```prisma
model UserProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  realName      String?  // 真实姓名(提现用)
  idCard        String?  // 身份证号(加密)
  wechat        String?  // 微信号
  qq            String?  // QQ号
  alipay        String?  // 支付宝账号
  
  // 偏好设置
  notifyEnabled Boolean  @default(true) // 是否接收通知
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
}
```

#### 1.3 point_records - 积分变动记录表

```prisma
model PointRecord {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          PointType   // 积分类型
  action        PointAction // 操作类型
  amount        Int         // 变动数量(正数增加,负数减少)
  balance       Int         // 变动后余额
  
  // 关联信息
  orderId       String?     // 关联订单ID
  description   String?     // 描述
  
  createdAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum PointType {
  FORMAL   // 正式积分
  TEMP     // 临时积分
}

enum PointAction {
  SIGN_IN           // 签到获得
  REFUND            // 拒单退还
  ADMIN_GRANT       // 管理员发放
  ORDER_USE         // 下单使用
  UNLOCK_CONTACT    // 解锁联系方式
  EXPIRE            // 过期清零
  REFERRAL_REWARD   // 推荐奖励
}
```

#### 1.4 sign_in_records - 签到记录表

```prisma
model SignInRecord {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  signInDate        DateTime @db.Date // 签到日期
  dayOfMonth        Int      // 当月第几天(1-31)
  consecutiveDays   Int      // 连续签到天数
  pointsEarned      Int      // 本次获得积分
  monthlyTotal      Int      // 本月累计积分
  
  createdAt         DateTime @default(now())
  
  @@unique([userId, signInDate])
  @@index([userId])
  @@index([signInDate])
}
```

#### 1.5 favorites - 技师收藏表

```prisma
model Favorite {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([userId, therapistId])
  @@index([userId])
  @@index([therapistId])
}
```

#### 1.6 contact_unlocks - 联系方式解锁记录表

```prisma
model ContactUnlock {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  cost        Int       @default(99) // 花费积分(默认99)
  unlockAt    DateTime  @default(now())
  
  @@unique([userId, therapistId])
  @@index([userId])
  @@index([therapistId])
}
```

#### 1.7 user_earnings - 用户推荐收益表

```prisma
model UserEarning {
  id            String         @id @default(cuid())
  userId        String         // 收益人ID
  fromUserId    String         // 被推荐用户ID
  orderId       String         // 订单ID
  order         Order          @relation(fields: [orderId], references: [id])
  
  amount        Decimal        @db.Decimal(10, 2) // 收益金额(订单总额10%)
  status        EarningStatus  @default(PENDING)
  
  createdAt     DateTime       @default(now())
  settledAt     DateTime?      // 结算时间
  
  @@index([userId])
  @@index([orderId])
  @@index([status])
}

enum EarningStatus {
  PENDING   // 待结算
  SETTLED   // 已结算
  WITHDRAWN // 已提现
}
```

---

### 二、技师相关表 (7张)

#### 2.1 therapists - 技师表 (核心)

```prisma
model Therapist {
  id                String          @id @default(cuid())
  phone             String          @unique // 手机号
  password          String          // 密码
  nickname          String          // 昵称/艺名
  
  // 基本信息
  age               Int             // 年龄
  height            Int             // 身高(cm)
  weight            Int             // 体重(kg)
  city              String          // 服务城市
  areas             String[]        // 服务区域(数组)
  
  // 审核状态
  status            TherapistStatus @default(PENDING)
  auditReason       String?         // 审核不通过原因
  
  // 在线状态
  isOnline          Boolean         @default(false)
  lastOnlineAt      DateTime?
  
  // 标签
  isNew             Boolean         @default(true)  // 新技师(注册30天内)
  isFeatured        Boolean         @default(false) // 推荐技师
  
  // 邀请码
  inviteCode        String          @unique // 技师邀请码(8位)
  invitedBy         String?         // 邀请人邀请码
  inviter           Therapist?      @relation("TherapistInvitations", fields: [invitedBy], references: [inviteCode])
  invitees          Therapist[]     @relation("TherapistInvitations")
  
  // 统计数据
  totalOrders       Int             @default(0) // 总接单数
  acceptedOrders    Int             @default(0) // 已接单数
  rejectedOrders    Int             @default(0) // 拒单数
  completedOrders   Int             @default(0) // 完成订单数
  totalEarnings     Decimal         @default(0) @db.Decimal(10, 2) // 累计收益
  withdrawableBalance Decimal       @default(0) @db.Decimal(10, 2) // 可提现余额
  
  // 评分
  rating            Decimal?        @db.Decimal(3, 2) // 平均评分(0-5)
  reviewCount       Int             @default(0) // 评价数
  
  // 时间戳
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  auditedAt         DateTime?       // 审核时间
  
  // 关联
  profile           TherapistProfile?
  photos            TherapistPhoto[]
  videos            TherapistVideo[]
  schedules         TherapistSchedule[]
  orders            Order[]
  reviews           Review[]
  favorites         Favorite[]
  unlocks           ContactUnlock[]
  earnings          TherapistEarning[]
  
  @@index([phone])
  @@index([status])
  @@index([city])
  @@index([isOnline])
  @@index([createdAt])
}

enum TherapistStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
  BANNED    // 已封禁
}
```

#### 2.2 therapist_profiles - 技师资料表

```prisma
model TherapistProfile {
  id              String    @id @default(cuid())
  therapistId     String    @unique
  therapist       Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  introduction    String    @db.Text // 个人介绍
  specialties     String[]  // 服务特色(数组)
  
  // 联系方式(加密存储)
  wechat          String?   // 微信号
  qq              String?   // QQ号
  
  // 服务方式
  serviceType     ServiceType[] // 服务方式(多选)
  serviceAddress  String?   // 服务地址
  serviceLat      Decimal?  @db.Decimal(10, 7) // 纬度
  serviceLng      Decimal?  @db.Decimal(10, 7) // 经度
  serviceRadius   Int?      // 服务半径(km)
  
  // 银行信息(提现用)
  realName        String?   // 真实姓名
  bankName        String?   // 银行名称
  bankAccount     String?   // 银行账号(加密)
  alipay          String?   // 支付宝账号
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([therapistId])
}

enum ServiceType {
  VISIT_CLIENT   // 上门服务
  CLIENT_VISIT   // 客户到店
  NEGOTIATE      // 双方协商
}
```

#### 2.3 therapist_photos - 技师照片表

```prisma
model TherapistPhoto {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  url         String    // 图片URL
  order       Int       @default(0) // 排序(数字越小越靠前)
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
  @@index([order])
}
```

#### 2.4 therapist_videos - 技师视频表

```prisma
model TherapistVideo {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  url         String    // 视频URL
  coverUrl    String?   // 封面图URL
  duration    Int?      // 时长(秒)
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
}
```

#### 2.5 therapist_schedules - 技师时间表

```prisma
model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  date        DateTime  @db.Date // 日期
  startTime   String    // 开始时间(HH:mm)
  endTime     String    // 结束时间(HH:mm)
  
  isAvailable Boolean   @default(true) // 是否可用
  isRecurring Boolean   @default(false) // 是否重复(每天)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([therapistId, date, startTime])
  @@index([therapistId])
  @@index([date])
}
```

#### 2.6 therapist_earnings - 技师推荐收益表

```prisma
model TherapistEarning {
  id              String         @id @default(cuid())
  therapistId     String         // 收益人ID
  fromTherapistId String         // 被推荐技师ID
  orderId         String         // 订单ID
  order           Order          @relation(fields: [orderId], references: [id])
  
  amount          Decimal        @db.Decimal(10, 2) // 收益金额(订单总额5%)
  status          EarningStatus  @default(PENDING)
  
  createdAt       DateTime       @default(now())
  settledAt       DateTime?
  
  @@index([therapistId])
  @@index([orderId])
  @@index([status])
}
```

#### 2.7 withdrawals - 提现记录表

```prisma
model Withdrawal {
  id            String           @id @default(cuid())
  therapistId   String
  therapist     Therapist        @relation(fields: [therapistId], references: [id])
  
  amount        Decimal          @db.Decimal(10, 2) // 提现金额
  fee           Decimal          @default(0) @db.Decimal(10, 2) // 手续费
  actualAmount  Decimal          @db.Decimal(10, 2) // 实际到账
  
  method        WithdrawMethod   // 提现方式
  account       String           // 收款账号
  accountName   String           // 收款人
  
  status        WithdrawStatus   @default(PENDING)
  rejectReason  String?          // 拒绝原因
  
  appliedAt     DateTime         @default(now())
  processedAt   DateTime?        // 处理时间
  completedAt   DateTime?        // 完成时间
  
  processedBy   String?          // 处理人(管理员ID)
  
  @@index([therapistId])
  @@index([status])
  @@index([appliedAt])
}

enum WithdrawMethod {
  ALIPAY  // 支付宝
  WECHAT  // 微信
  BANK    // 银行卡
}

enum WithdrawStatus {
  PENDING    // 待审核
  PROCESSING // 处理中
  COMPLETED  // 已完成
  REJECTED   // 已拒绝
}
```

---

### 三、订单相关表 (4张)

#### 3.1 orders - 订单表 (核心)

```prisma
model Order {
  id            String       @id @default(cuid())
  orderNo       String       @unique // 订单号(自动生成)
  
  // 用户信息
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  
  // 技师信息
  therapistId   String
  therapist     Therapist    @relation(fields: [therapistId], references: [id])
  
  // 服务信息
  serviceId     String
  service       Service      @relation(fields: [serviceId], references: [id])
  
  // 预约信息
  appointmentDate DateTime   @db.Date // 预约日期
  appointmentTime String     // 预约时间(HH:mm)
  serviceType     ServiceType // 服务方式
  address         String     // 服务地址
  addressLat      Decimal?   @db.Decimal(10, 7) // 纬度
  addressLng      Decimal?   @db.Decimal(10, 7) // 经度
  
  // 联系信息
  customerName    String     // 客户姓名
  customerPhone   String     // 客户电话
  
  // 金额信息
  totalAmount     Decimal    @db.Decimal(10, 2) // 订单总额
  depositAmount   Decimal    @db.Decimal(10, 2) // 定金金额(50%)
  balanceAmount   Decimal    @db.Decimal(10, 2) // 尾款金额(50%)
  
  // 积分抵扣
  formalPointsUsed Int       @default(0) // 使用正式积分
  tempPointsUsed   Int       @default(0) // 使用临时积分
  pointsDiscount   Decimal   @default(0) @db.Decimal(10, 2) // 积分抵扣金额
  
  // 实际支付
  actualPaid       Decimal   @db.Decimal(10, 2) // 实际支付金额
  
  // 订单状态
  status           OrderStatus @default(PENDING_PAYMENT)
  
  // 支付信息
  paymentMethod    String?    // 支付方式(semipay)
  paymentTime      DateTime?  // 支付时间
  paymentNo        String?    // 支付流水号
  
  // 接单信息
  acceptedAt       DateTime?  // 接单时间
  rejectedAt       DateTime?  // 拒单时间
  rejectReason     String?    // 拒单原因
  
  // 完成信息
  completedAt      DateTime?  // 完成时间
  
  // 特殊备注
  remarks          String?    @db.Text // 用户备注
  
  // 政策确认
  policyAgreed     Boolean    @default(false) // 是否同意"只换不退"政策
  
  // 时间戳
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  
  // 关联
  statusLogs       OrderStatusLog[]
  review           Review?
  userEarnings     UserEarning[]
  therapistEarnings TherapistEarning[]
  
  @@index([orderNo])
  @@index([userId])
  @@index([therapistId])
  @@index([status])
  @@index([createdAt])
  @@index([appointmentDate])
}

enum OrderStatus {
  PENDING_PAYMENT  // 待支付
  PENDING_ACCEPT   // 待接单
  ACCEPTED         // 已接单
  IN_SERVICE       // 服务中
  COMPLETED        // 已完成
  REVIEWED         // 已评价
  REJECTED         // 已拒单
  REFUNDED         // 已退款(积分)
  CANCELLED        // 已取消
}
```

#### 3.2 order_status_logs - 订单状态变更日志表

```prisma
model OrderStatusLog {
  id          String      @id @default(cuid())
  orderId     String
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  fromStatus  OrderStatus? // 原状态
  toStatus    OrderStatus  // 新状态
  
  operator    String?     // 操作人(用户/技师/系统/管理员)
  operatorType String?    // 操作人类型
  reason      String?     // 原因/备注
  
  createdAt   DateTime    @default(now())
  
  @@index([orderId])
  @@index([createdAt])
}
```

#### 3.3 reviews - 订单评价表

```prisma
model Review {
  id          String   @id @default(cuid())
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id])
  
  rating      Int      // 评分(1-5星)
  content     String?  @db.Text // 评价内容(可选)
  
  // 审核状态
  isApproved  Boolean  @default(false) // 是否通过审核
  isVisible   Boolean  @default(false) // 是否显示
  
  createdAt   DateTime @default(now())
  approvedAt  DateTime? // 审核通过时间
  approvedBy  String?  // 审核人(管理员ID)
  
  @@index([orderId])
  @@index([userId])
  @@index([therapistId])
  @@index([isVisible])
}
```

#### 3.4 complaints - 投诉申诉表

```prisma
model Complaint {
  id            String          @id @default(cuid())
  orderId       String
  
  complainant   String          // 投诉人ID
  complainantType String        // 投诉人类型(user/therapist)
  
  reason        String          @db.Text // 投诉原因
  evidence      String[]        // 证据(图片URLs)
  
  status        ComplaintStatus @default(PENDING)
  result        String?         @db.Text // 处理结果
  
  createdAt     DateTime        @default(now())
  processedAt   DateTime?
  processedBy   String?         // 处理人(管理员ID)
  
  @@index([orderId])
  @@index([status])
}

enum ComplaintStatus {
  PENDING    // 待处理
  PROCESSING // 处理中
  RESOLVED   // 已解决
  REJECTED   // 已驳回
}
```

---

### 四、服务相关表 (3张)

#### 4.1 services - 服务项目表

```prisma
model Service {
  id          String   @id @default(cuid())
  name        String   // 服务名称
  description String   @db.Text // 服务描述
  price       Decimal  @db.Decimal(10, 2) // 价格
  duration    Int      // 服务时长(分钟)
  
  features    String[] // 服务特色(数组)
  
  order       Int      @default(0) // 排序
  isActive    Boolean  @default(true) // 是否启用
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  orders      Order[]
  
  @@index([isActive])
  @@index([order])
}
```

#### 4.2 cities - 城市表

```prisma
model City {
  id          String   @id @default(cuid())
  name        String   @unique // 城市名称
  province    String   // 省份
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  areas       Area[]
  
  @@index([isActive])
}
```

#### 4.3 areas - 区域表

```prisma
model Area {
  id          String   @id @default(cuid())
  cityId      String
  city        City     @relation(fields: [cityId], references: [id])
  
  name        String   // 区域名称
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  @@index([cityId])
  @@index([isActive])
}
```

---

### 五、邀请分佣表 (5张)

#### 5.1 invitations - 邀请关系表

```prisma
model Invitation {
  id            String   @id @default(cuid())
  inviteCode    String   @unique // 邀请码
  inviterType   String   // 邀请人类型(user/therapist/agent)
  inviterId     String   // 邀请人ID
  
  inviteeType   String   // 被邀请人类型
  inviteeId     String   // 被邀请人ID
  
  createdAt     DateTime @default(now())
  
  @@index([inviteCode])
  @@index([inviterId])
}
```

#### 5.2 agents - 代理商表

```prisma
model Agent {
  id            String   @id @default(cuid())
  name          String   // 代理商名称
  phone         String   @unique
  password      String
  
  inviteCode    String   @unique // 代理专属邀请码
  commissionRate Decimal @db.Decimal(5, 2) // 佣金比例(%)
  
  totalEarnings Decimal  @default(0) @db.Decimal(10, 2) // 累计收益
  withdrawableBalance Decimal @default(0) @db.Decimal(10, 2) // 可提现余额
  
  status        AgentStatus @default(ACTIVE)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  earnings      AgentEarning[]
  
  @@index([inviteCode])
}

enum AgentStatus {
  ACTIVE
  SUSPENDED
  BANNED
}
```

#### 5.3 agent_earnings - 代理收益表

```prisma
model AgentEarning {
  id          String         @id @default(cuid())
  agentId     String
  agent       Agent          @relation(fields: [agentId], references: [id])
  
  orderId     String         // 关联订单
  amount      Decimal        @db.Decimal(10, 2) // 收益金额
  
  status      EarningStatus  @default(PENDING)
  
  createdAt   DateTime       @default(now())
  settledAt   DateTime?
  
  @@index([agentId])
}
```

#### 5.4 referral_configs - 分佣配置表

```prisma
model ReferralConfig {
  id                    String   @id @default(cuid())
  
  userReferralRate      Decimal  @db.Decimal(5, 2) // 用户推荐佣金比例(默认10%)
  therapistReferralRate Decimal  @db.Decimal(5, 2) // 技师推荐佣金比例(默认5%)
  
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // 更新人(管理员ID)
}
```

#### 5.5 transactions - 交易流水表

```prisma
model Transaction {
  id            String          @id @default(cuid())
  transactionNo String          @unique // 流水号
  
  type          TransactionType // 交易类型
  relatedId     String?         // 关联ID(订单/提现)
  
  userId        String?         // 用户ID
  therapistId   String?         // 技师ID
  agentId       String?         // 代理ID
  
  amount        Decimal         @db.Decimal(10, 2) // 金额
  balance       Decimal         @db.Decimal(10, 2) // 变动后余额
  
  description   String?         // 描述
  
  createdAt     DateTime        @default(now())
  
  @@index([userId])
  @@index([therapistId])
  @@index([type])
  @@index([createdAt])
}

enum TransactionType {
  ORDER_DEPOSIT      // 订单定金
  ORDER_REFUND       // 订单退款
  REFERRAL_REWARD    // 推荐奖励
  WITHDRAWAL         // 提现
  ADMIN_ADJUSTMENT   // 管理员调整
}
```

---

### 六、系统相关表 (5张)

#### 6.1 admin_users - 管理员表

```prisma
model AdminUser {
  id          String     @id @default(cuid())
  username    String     @unique
  password    String
  realName    String?
  
  role        AdminRole  @default(OPERATOR)
  permissions String[]   // 权限列表(数组)
  
  status      Boolean    @default(true) // 是否启用
  
  lastLoginAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([username])
}

enum AdminRole {
  SUPER_ADMIN  // 超级管理员
  ADMIN        // 管理员
  OPERATOR     // 运营
  CUSTOMER_SERVICE // 客服
}
```

#### 6.2 notifications - 通知消息表

```prisma
model Notification {
  id          String           @id @default(cuid())
  userId      String?
  user        User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  content     String           @db.Text
  
  relatedId   String?          // 关联ID(订单/提现)
  
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  SYSTEM       // 系统通知
  ORDER        // 订单通知
  PAYMENT      // 支付通知
  REVIEW       // 评价通知
  WITHDRAWAL   // 提现通知
  PROMOTION    // 推广通知
}
```

#### 6.3 announcements - 公告表

```prisma
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  
  target      String[] // 目标受众(user/therapist/all)
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  createdBy   String?  // 创建人(管理员ID)
  
  @@index([isActive])
  @@index([order])
}
```

#### 6.4 feedbacks - 留言反馈表

```prisma
model Feedback {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  
  content     String         @db.Text // 留言内容
  
  reply       String?        @db.Text // 回复内容
  repliedAt   DateTime?
  repliedBy   String?        // 回复人(管理员ID)
  
  status      FeedbackStatus @default(PENDING)
  
  createdAt   DateTime       @default(now())
  
  @@index([userId])
  @@index([status])
}

enum FeedbackStatus {
  PENDING  // 待处理
  REPLIED  // 已回复
  CLOSED   // 已关闭
}
```

#### 6.5 system_configs - 系统配置表

```prisma
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique // 配置键
  value       String   @db.Text // 配置值(JSON)
  description String?  // 描述
  
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // 更新人(管理员ID)
  
  @@index([key])
}
```

---

## 🔗 表关系图

```
用户系统：
User ──< UserProfile
User ──< PointRecord
User ──< SignInRecord
User ──< Favorite >── Therapist
User ──< ContactUnlock >── Therapist
User ──< Order

技师系统：
Therapist ──< TherapistProfile
Therapist ──< TherapistPhoto
Therapist ──< TherapistVideo
Therapist ──< TherapistSchedule
Therapist ──< Order

订单系统：
Order >── User
Order >── Therapist
Order >── Service
Order ──< OrderStatusLog
Order ──○ Review (一对一)

邀请分佣：
User >── User (自关联)
Therapist >── Therapist (自关联)
Agent ──< AgentEarning

系统：
User ──< Notification
User ──< Feedback
```

**符号说明**：
- `──<` : 一对多
- `>──` : 多对一
- `──○` : 一对一
- `>──<` : 多对多

---

## 📇 索引设计

### 性能优化索引

```sql
-- 用户表
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_invite_code ON users(invite_code);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 技师表
CREATE INDEX idx_therapists_phone ON therapists(phone);
CREATE INDEX idx_therapists_status ON therapists(status);
CREATE INDEX idx_therapists_city ON therapists(city);
CREATE INDEX idx_therapists_online ON therapists(is_online);
CREATE INDEX idx_therapists_rating ON therapists(rating);

-- 订单表
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_therapist_id ON orders(therapist_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_appointment_date ON orders(appointment_date);

-- 复合索引
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_therapist_status ON orders(therapist_id, status);
CREATE INDEX idx_sign_in_user_date ON sign_in_records(user_id, sign_in_date);
```

---

## 📊 数据统计需求

### 管理端数据看板SQL视图

```sql
-- 今日数据统计
CREATE VIEW daily_stats AS
SELECT
  DATE(created_at) as date,
  COUNT(DISTINCT user_id) as new_users,
  COUNT(*) as total_orders,
  SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_orders,
  SUM(CASE WHEN status = 'COMPLETED' THEN actual_paid ELSE 0 END) as gmv
FROM orders
GROUP BY DATE(created_at);

-- 技师绩效统计
CREATE VIEW therapist_performance AS
SELECT
  therapist_id,
  COUNT(*) as total_orders,
  SUM(CASE WHEN status = 'ACCEPTED' THEN 1 ELSE 0 END) as accepted_orders,
  SUM(CASE WHEN status = 'REJECTED' THEN 1 ELSE 0 END) as rejected_orders,
  ROUND(SUM(CASE WHEN status = 'ACCEPTED' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as accept_rate,
  AVG(rating) as avg_rating
FROM orders
LEFT JOIN reviews ON orders.id = reviews.order_id
GROUP BY therapist_id;
```

---

## 🔐 安全与备份

### 敏感字段加密
- `users.password` - bcrypt加密
- `therapists.password` - bcrypt加密
- `admin_users.password` - bcrypt加密
- `user_profiles.id_card` - AES加密
- `therapist_profiles.bank_account` - AES加密

### 备份策略
- 每日全量备份: 凌晨3点
- 每小时增量备份
- 保留最近7天备份
- 每周备份上传到云存储

---

## 📝 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| v1.0 | 2025-10-08 | 初始版本，完整数据库设计 |

---

**文档结束**

