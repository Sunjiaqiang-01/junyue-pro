# å›æ‚¦SPA - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-11  
> **æ•°æ®åº“**: PostgreSQL 16  
> **ORM**: Prisma  
> **ç¼–ç **: UTF-8

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
- [æ ¸å¿ƒè¡¨ç»“æ„](#æ ¸å¿ƒè¡¨ç»“æ„)
- [è¡¨å…³ç³»å›¾](#è¡¨å…³ç³»å›¾)
- [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)

---

## ğŸ“Š æ•°æ®åº“æ¦‚è¿°

### è®¾è®¡åŸåˆ™

1. **ç®€åŒ–ä¼˜å…ˆ**: åˆ é™¤ä¸å¿…è¦çš„è¡¨ï¼Œä¿ç•™æ ¸å¿ƒåŠŸèƒ½
2. **æ€§èƒ½ä¼˜åŒ–**: åˆç†è®¾è®¡ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
3. **å®‰å…¨æ€§**: æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
4. **æ‰©å±•æ€§**: é¢„ç•™å­—æ®µï¼Œæ”¯æŒä¸šåŠ¡æ‰©å±•

### æ•°æ®è¡¨åˆ†ç±»

- **æŠ€å¸ˆç›¸å…³**: 5å¼ è¡¨
- **æœåŠ¡ç›¸å…³**: 2å¼ è¡¨
- **ç³»ç»Ÿç›¸å…³**: 4å¼ è¡¨

**æ€»è®¡**: 11å¼ æ ¸å¿ƒæ•°æ®è¡¨

---

## ğŸ—„ï¸ æ ¸å¿ƒè¡¨ç»“æ„

### ä¸€ã€æŠ€å¸ˆç›¸å…³è¡¨ (5å¼ )

#### 1.1 therapists - æŠ€å¸ˆè¡¨

```prisma
model Therapist {
  id                  String            @id @default(cuid())
  phone               String            @unique
  password            String            // bcryptåŠ å¯†
  nickname            String

  // åŸºæœ¬ä¿¡æ¯
  age                 Int
  height              Int               // èº«é«˜(cm)
  weight              Int               // ä½“é‡(kg)
  cardValue           String?           // ğŸ†• ç‰Œå€¼(ä¾‹å¦‚ï¼š"17cm")
  city                String
  areas               String[]          // æœåŠ¡åŒºåŸŸ(æ•°ç»„)
  location            Json?             // ğŸ†• ä½ç½®ä¿¡æ¯ {name, street, latitude, longitude}

  // å®¡æ ¸çŠ¶æ€
  status              TherapistStatus   @default(PENDING)
  auditReason         String?           // å®¡æ ¸ä¸é€šè¿‡åŸå› 

  // åœ¨çº¿çŠ¶æ€
  isOnline            Boolean           @default(false)
  lastOnlineAt        DateTime?

  // æ ‡ç­¾
  isNew               Boolean           @default(true)   // æ–°æŠ€å¸ˆ(æ³¨å†Œ30å¤©å†…)
  isFeatured          Boolean           @default(false)  // æ¨èæŠ€å¸ˆ

  // é‚€è¯·ç (å¯é€‰)
  inviteCode          String            @unique
  invitedBy           String?
  inviter             Therapist?        @relation("TherapistInvitations", fields: [invitedBy], references: [inviteCode])
  invitees            Therapist[]       @relation("TherapistInvitations")

  // æ—¶é—´æˆ³
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  auditedAt           DateTime?

  // å…³è”
  profile             TherapistProfile?
  photos              TherapistPhoto[]
  videos              TherapistVideo[]
  schedules           TherapistSchedule[]
  notifications       Notification[]

  @@index([phone])
  @@index([status])
  @@index([city])
  @@index([isOnline])
  @@index([createdAt])
  @@map("therapists")
}

enum TherapistStatus {
  PENDING   // å¾…å®¡æ ¸
  APPROVED  // å·²é€šè¿‡
  REJECTED  // å·²æ‹’ç»
  BANNED    // å·²å°ç¦
}
```

**å­—æ®µè¯´æ˜**:

- `invitedBy`: é‚€è¯·äººé‚€è¯·ç ï¼ˆå¯é€‰ï¼Œéå¿…å¡«ï¼‰
- `isNew`: æ³¨å†Œ30å¤©å†…è‡ªåŠ¨æ ‡è®°ä¸ºæ–°æŠ€å¸ˆ
- `isFeatured`: ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®æ¨èæŠ€å¸ˆ

---

#### 1.2 therapist_profiles - æŠ€å¸ˆèµ„æ–™è¡¨

```prisma
model TherapistProfile {
  id              String        @id @default(cuid())
  therapistId     String        @unique
  therapist       Therapist     @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  introduction    String        @db.Text  // ä¸ªäººä»‹ç»
  specialties     String[]                // æœåŠ¡ç‰¹è‰²(æ•°ç»„)

  // è”ç³»æ–¹å¼(åŠ å¯†å­˜å‚¨ï¼Œä»…ç®¡ç†ç«¯å¯è§)
  wechat          String?
  qq              String?
  phone           String?

  // æœåŠ¡ä¿¡æ¯
  serviceType     ServiceType[]           // æœåŠ¡æ–¹å¼(æ•°ç»„)
  serviceAddress  String?                 // æœåŠ¡åœ°å€
  serviceLat      Decimal?      @db.Decimal(10, 7)  // çº¬åº¦
  serviceLng      Decimal?      @db.Decimal(10, 7)  // ç»åº¦
  serviceRadius   Int?                    // æœåŠ¡åŠå¾„(km)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([therapistId])
  @@map("therapist_profiles")
}

enum ServiceType {
  VISIT_CLIENT  // ä¸Šé—¨æœåŠ¡
  CLIENT_VISIT  // å®¢æˆ·åˆ°åº—
  NEGOTIATE     // åŒæ–¹åå•†
}
```

**å®‰å…¨è¯´æ˜**:

- è”ç³»æ–¹å¼å­—æ®µï¼ˆwechat, qq, phoneï¼‰åœ¨APIè¿”å›æ—¶ï¼Œç”¨æˆ·ç«¯ä¸è¿”å›ï¼Œä»…ç®¡ç†ç«¯è¿”å›

---

#### 1.3 therapist_photos - æŠ€å¸ˆç…§ç‰‡è¡¨

```prisma
model TherapistPhoto {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  url         String    // å›¾ç‰‡URL
  order       Int       @default(0)  // æ’åº(æ•°å­—è¶Šå°è¶Šé å‰)

  createdAt   DateTime  @default(now())

  @@index([therapistId])
  @@index([order])
  @@map("therapist_photos")
}
```

---

#### 1.4 therapist_videos - æŠ€å¸ˆè§†é¢‘è¡¨

```prisma
model TherapistVideo {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  url         String    // è§†é¢‘URL
  coverUrl    String?   // å°é¢å›¾URL
  duration    Int?      // æ—¶é•¿(ç§’)

  createdAt   DateTime  @default(now())

  @@index([therapistId])
  @@map("therapist_videos")
}
```

---

#### 1.5 therapist_schedules - æŠ€å¸ˆæ—¶é—´è¡¨

```prisma
model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  date        DateTime  @db.Date      // æ—¥æœŸ
  startTime   String                  // å¼€å§‹æ—¶é—´(HH:mm)
  endTime     String                  // ç»“æŸæ—¶é—´(HH:mm)

  isAvailable Boolean   @default(true)  // æ˜¯å¦å¯ç”¨
  isRecurring Boolean   @default(false) // æ˜¯å¦é‡å¤(æ¯å¤©)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([therapistId, date, startTime])
  @@index([therapistId])
  @@index([date])
  @@map("therapist_schedules")
}
```

---

### äºŒã€æœåŠ¡ç›¸å…³è¡¨ (2å¼ )

#### 2.1 cities - åŸå¸‚è¡¨

```prisma
model City {
  id        String    @id @default(cuid())
  name      String    @unique
  code      String    @unique  // åŸå¸‚ä»£ç 

  isActive  Boolean   @default(true)
  order     Int       @default(0)  // æ’åº

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  areas     Area[]

  @@index([isActive])
  @@index([order])
  @@map("cities")
}
```

---

#### 2.2 areas - åŒºåŸŸè¡¨

```prisma
model Area {
  id        String    @id @default(cuid())
  cityId    String
  city      City      @relation(fields: [cityId], references: [id])
  name      String
  code      String    // åŒºåŸŸä»£ç 

  isActive  Boolean   @default(true)
  order     Int       @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([cityId, name])
  @@index([cityId])
  @@index([isActive])
  @@map("areas")
}
```

---

### ä¸‰ã€ç³»ç»Ÿç›¸å…³è¡¨ (4å¼ )

#### 3.1 admins - ç®¡ç†å‘˜è¡¨

```prisma
model Admin {
  id          String      @id @default(cuid())
  username    String      @unique
  password    String      // bcryptåŠ å¯†
  name        String

  role        AdminRole   @default(ADMIN)

  lastLoginAt DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([username])
  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN  // è¶…çº§ç®¡ç†å‘˜
  ADMIN        // ç®¡ç†å‘˜
  OPERATOR     // è¿è¥
}
```

---

#### 3.2 notifications - é€šçŸ¥æ¶ˆæ¯è¡¨

```prisma
model Notification {
  id          String           @id @default(cuid())

  therapistId String?
  therapist   Therapist?       @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  type        NotificationType
  title       String
  content     String           @db.Text

  isRead      Boolean          @default(false)
  readAt      DateTime?

  createdAt   DateTime         @default(now())

  @@index([therapistId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM       // ç³»ç»Ÿé€šçŸ¥
  AUDIT        // å®¡æ ¸é€šçŸ¥
  ANNOUNCEMENT // å…¬å‘Šé€šçŸ¥
}
```

---

#### 3.3 announcements - å…¬å‘Šè¡¨

```prisma
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text

  type        AnnouncementType @default(NOTICE)

  isPublished Boolean   @default(false)
  publishedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
  @@index([isPublished])
  @@index([publishedAt])
  @@map("announcements")
}

enum AnnouncementType {
  NOTICE      // é€šçŸ¥
  ACTIVITY    // æ´»åŠ¨
  MAINTENANCE // ç»´æŠ¤
}
```

---

#### 3.4 customer_services - å®¢æœé…ç½®è¡¨

```prisma
model CustomerService {
  id              String   @id @default(cuid())
  wechatQrCode    String   // å®¢æœå¾®ä¿¡äºŒç»´ç URL
  wechatId        String?  // å®¢æœå¾®ä¿¡å·
  phone           String?  // å®¢æœç”µè¯
  workingHours    String   // å·¥ä½œæ—¶é—´(å¦‚: 9:00-22:00)

  isActive        Boolean  @default(true)
  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@map("customer_services")
}
```

---

## ğŸ”— è¡¨å…³ç³»å›¾

```
æŠ€å¸ˆç³»ç»Ÿï¼š
Therapist â”€â”€< TherapistProfile (ä¸€å¯¹ä¸€)
Therapist â”€â”€< TherapistPhoto (ä¸€å¯¹å¤š)
Therapist â”€â”€< TherapistVideo (ä¸€å¯¹å¤š)
Therapist â”€â”€< TherapistSchedule (ä¸€å¯¹å¤š)
Therapist â”€â”€< Notification (ä¸€å¯¹å¤š)
Therapist >â”€â”€ Therapist (è‡ªå…³è”ï¼Œé‚€è¯·å…³ç³»ï¼Œå¯é€‰)

æœåŠ¡ç³»ç»Ÿï¼š
City â”€â”€< Area (ä¸€å¯¹å¤š)

ç³»ç»Ÿï¼š
æ— å…³è”å…³ç³»
```

**ç¬¦å·è¯´æ˜**ï¼š

- `â”€â”€<` : ä¸€å¯¹å¤š
- `>â”€â”€` : å¤šå¯¹ä¸€
- `â”€â”€â—‹` : ä¸€å¯¹ä¸€

---

## ğŸ“‡ ç´¢å¼•è®¾è®¡

### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

```sql
-- æŠ€å¸ˆè¡¨
CREATE INDEX idx_therapists_phone ON therapists(phone);
CREATE INDEX idx_therapists_status ON therapists(status);
CREATE INDEX idx_therapists_city ON therapists(city);
CREATE INDEX idx_therapists_online ON therapists(is_online);
CREATE INDEX idx_therapists_created_at ON therapists(created_at);

-- æŠ€å¸ˆç…§ç‰‡è¡¨
CREATE INDEX idx_therapist_photos_therapist_id ON therapist_photos(therapist_id);
CREATE INDEX idx_therapist_photos_order ON therapist_photos(order);

-- æŠ€å¸ˆæ—¶é—´è¡¨
CREATE INDEX idx_therapist_schedules_therapist_id ON therapist_schedules(therapist_id);
CREATE INDEX idx_therapist_schedules_date ON therapist_schedules(date);

-- åŸå¸‚è¡¨
CREATE INDEX idx_cities_active ON cities(is_active);
CREATE INDEX idx_cities_order ON cities(order);

-- åŒºåŸŸè¡¨
CREATE INDEX idx_areas_city_id ON areas(city_id);
CREATE INDEX idx_areas_active ON areas(is_active);

-- ç®¡ç†å‘˜è¡¨
CREATE INDEX idx_admins_username ON admins(username);

-- é€šçŸ¥è¡¨
CREATE INDEX idx_notifications_therapist_id ON notifications(therapist_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);

-- å…¬å‘Šè¡¨
CREATE INDEX idx_announcements_type ON announcements(type);
CREATE INDEX idx_announcements_published ON announcements(is_published);
```

---

## ğŸ” å®‰å…¨ä¸å¤‡ä»½

### æ•æ„Ÿå­—æ®µåŠ å¯†

- `therapists.password` - bcryptåŠ å¯†
- `admins.password` - bcryptåŠ å¯†
- `therapist_profiles.wechat` - ä»…ç®¡ç†ç«¯å¯è§
- `therapist_profiles.qq` - ä»…ç®¡ç†ç«¯å¯è§
- `therapist_profiles.phone` - ä»…ç®¡ç†ç«¯å¯è§

### æ•°æ®è®¿é—®æ§åˆ¶

**ç”¨æˆ·ç«¯API**:

- âŒ ä¸è¿”å› `therapist_profiles` çš„è”ç³»æ–¹å¼å­—æ®µ

**ç®¡ç†ç«¯API**:

- âœ… è¿”å›å®Œæ•´çš„ `therapist_profiles` åŒ…æ‹¬è”ç³»æ–¹å¼

### å¤‡ä»½ç­–ç•¥

- æ¯æ—¥å…¨é‡å¤‡ä»½: å‡Œæ™¨3ç‚¹
- ä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½
- æ¯å‘¨å¤‡ä»½ä¸Šä¼ åˆ°äº‘å­˜å‚¨

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡éœ€æ±‚

### ç®¡ç†ç«¯æ•°æ®çœ‹æ¿SQL

```sql
-- æŠ€å¸ˆç»Ÿè®¡
SELECT
  COUNT(*) as total_therapists,
  COUNT(CASE WHEN status = 'APPROVED' THEN 1 END) as approved_therapists,
  COUNT(CASE WHEN status = 'PENDING' THEN 1 END) as pending_therapists,
  COUNT(CASE WHEN is_online = true THEN 1 END) as online_therapists,
  COUNT(CASE WHEN is_new = true THEN 1 END) as new_therapists,
  COUNT(CASE WHEN is_featured = true THEN 1 END) as featured_therapists
FROM therapists;

-- åŸå¸‚åˆ†å¸ƒ
SELECT
  city,
  COUNT(*) as count
FROM therapists
WHERE status = 'APPROVED'
GROUP BY city
ORDER BY count DESC;

-- ä»Šæ—¥æ–°å¢
SELECT COUNT(*) as today_new
FROM therapists
WHERE DATE(created_at) = CURRENT_DATE;

-- å®¡æ ¸é€šè¿‡ç‡
SELECT
  ROUND(
    COUNT(CASE WHEN status = 'APPROVED' THEN 1 END) * 100.0 /
    COUNT(CASE WHEN status IN ('APPROVED', 'REJECTED') THEN 1 END),
    2
  ) as approval_rate
FROM therapists
WHERE status IN ('APPROVED', 'REJECTED');
```

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | å˜æ›´è¯´æ˜                           |
| ---- | ---------- | ---------------------------------- |
| v1.0 | 2025-10-08 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´é¢„çº¦å¹³å°è®¾è®¡         |
| v2.0 | 2025-10-11 | ç®€åŒ–ç‰ˆæœ¬ï¼Œåˆ é™¤ç”¨æˆ·/è®¢å•/åˆ†ä½£ç›¸å…³è¡¨ |

---

**æ–‡æ¡£ç»“æŸ**
