# å›æ‚¦SPA - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-08  
> **æ•°æ®åº“**: PostgreSQL 16  
> **ORM**: Prisma  
> **ç¼–ç **: UTF-8

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
- [æ ¸å¿ƒè¡¨ç»“æ„](#æ ¸å¿ƒè¡¨ç»“æ„)
- [è¡¨å…³ç³»å›¾](#è¡¨å…³ç³»å›¾)
- [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)
- [æ•°æ®å­—å…¸](#æ•°æ®å­—å…¸)

---

## ğŸ“Š æ•°æ®åº“æ¦‚è¿°

### è®¾è®¡åŸåˆ™
1. **èŒƒå¼åŒ–è®¾è®¡**: éµå¾ªç¬¬ä¸‰èŒƒå¼,å‡å°‘æ•°æ®å†—ä½™
2. **æ€§èƒ½ä¼˜åŒ–**: åˆç†è®¾è®¡ç´¢å¼•,ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
3. **æ‰©å±•æ€§**: é¢„ç•™å­—æ®µ,æ”¯æŒä¸šåŠ¡æ‰©å±•
4. **æ•°æ®å®Œæ•´æ€§**: å¤–é”®çº¦æŸ,ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
5. **å®‰å…¨æ€§**: æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

### æ•°æ®è¡¨åˆ†ç±»
- **ç”¨æˆ·ç›¸å…³**: 7å¼ è¡¨
- **æŠ€å¸ˆç›¸å…³**: 7å¼ è¡¨
- **è®¢å•ç›¸å…³**: 4å¼ è¡¨
- **æœåŠ¡ç›¸å…³**: 3å¼ è¡¨
- **é‚€è¯·åˆ†ä½£**: 5å¼ è¡¨
- **è´¢åŠ¡ç›¸å…³**: 4å¼ è¡¨
- **ç³»ç»Ÿç›¸å…³**: 5å¼ è¡¨

**æ€»è®¡**: 35å¼ æ ¸å¿ƒæ•°æ®è¡¨

---

## ğŸ—„ï¸ æ ¸å¿ƒè¡¨ç»“æ„

### ä¸€ã€ç”¨æˆ·ç›¸å…³è¡¨ (7å¼ )

#### 1.1 users - ç”¨æˆ·è¡¨ (æ ¸å¿ƒ)

```prisma
model User {
  id                String    @id @default(cuid())
  phone             String    @unique // æ‰‹æœºå·(å”¯ä¸€)
  password          String    // å¯†ç (bcryptåŠ å¯†)
  nickname          String?   // æ˜µç§°
  avatar            String?   // å¤´åƒURL
  
  // ç§¯åˆ†ç›¸å…³
  formalPoints      Int       @default(0) // æ­£å¼ç§¯åˆ†(æ°¸ä¹…æœ‰æ•ˆ)
  tempPoints        Int       @default(0) // ä¸´æ—¶ç§¯åˆ†(60å¤©è¿‡æœŸ)
  tempPointsExpireAt DateTime? // ä¸´æ—¶ç§¯åˆ†è¿‡æœŸæ—¶é—´
  
  // é‚€è¯·ç 
  inviteCode        String    @unique // ç”¨æˆ·é‚€è¯·ç (8ä½)
  invitedBy         String?   // é‚€è¯·äººé‚€è¯·ç 
  inviter           User?     @relation("UserInvitations", fields: [invitedBy], references: [inviteCode])
  invitees          User[]    @relation("UserInvitations")
  
  // ç»Ÿè®¡æ•°æ®
  totalOrders       Int       @default(0) // æ€»è®¢å•æ•°
  totalSpent        Decimal   @default(0) @db.Decimal(10, 2) // ç´¯è®¡æ¶ˆè´¹
  totalEarnings     Decimal   @default(0) @db.Decimal(10, 2) // æ¨èæ”¶ç›Š
  
  // çŠ¶æ€
  status            UserStatus @default(ACTIVE) // è´¦å·çŠ¶æ€
  lastLoginAt       DateTime?  // æœ€åç™»å½•æ—¶é—´
  
  // æ—¶é—´æˆ³
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // å…³è”
  profile           UserProfile?
  orders            Order[]
  reviews           Review[]
  favorites         Favorite[]
  pointRecords      PointRecord[]
  signInRecords     SignInRecord[]
  notifications     Notification[]
  feedbacks         Feedback[]
  unlocks           ContactUnlock[]
  
  @@index([phone])
  @@index([inviteCode])
  @@index([status])
  @@index([createdAt])
}

enum UserStatus {
  ACTIVE      // æ­£å¸¸
  BANNED      // å°ç¦
  SUSPENDED   // æš‚åœ
}
```

#### 1.2 user_profiles - ç”¨æˆ·èµ„æ–™æ‰©å±•è¡¨

```prisma
model UserProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  realName      String?  // çœŸå®å§“å(æç°ç”¨)
  idCard        String?  // èº«ä»½è¯å·(åŠ å¯†)
  wechat        String?  // å¾®ä¿¡å·
  qq            String?  // QQå·
  alipay        String?  // æ”¯ä»˜å®è´¦å·
  
  // åå¥½è®¾ç½®
  notifyEnabled Boolean  @default(true) // æ˜¯å¦æ¥æ”¶é€šçŸ¥
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
}
```

#### 1.3 point_records - ç§¯åˆ†å˜åŠ¨è®°å½•è¡¨

```prisma
model PointRecord {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          PointType   // ç§¯åˆ†ç±»å‹
  action        PointAction // æ“ä½œç±»å‹
  amount        Int         // å˜åŠ¨æ•°é‡(æ­£æ•°å¢åŠ ,è´Ÿæ•°å‡å°‘)
  balance       Int         // å˜åŠ¨åä½™é¢
  
  // å…³è”ä¿¡æ¯
  orderId       String?     // å…³è”è®¢å•ID
  description   String?     // æè¿°
  
  createdAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum PointType {
  FORMAL   // æ­£å¼ç§¯åˆ†
  TEMP     // ä¸´æ—¶ç§¯åˆ†
}

enum PointAction {
  SIGN_IN           // ç­¾åˆ°è·å¾—
  REFUND            // æ‹’å•é€€è¿˜
  ADMIN_GRANT       // ç®¡ç†å‘˜å‘æ”¾
  ORDER_USE         // ä¸‹å•ä½¿ç”¨
  UNLOCK_CONTACT    // è§£é”è”ç³»æ–¹å¼
  EXPIRE            // è¿‡æœŸæ¸…é›¶
  REFERRAL_REWARD   // æ¨èå¥–åŠ±
}
```

#### 1.4 sign_in_records - ç­¾åˆ°è®°å½•è¡¨

```prisma
model SignInRecord {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  signInDate        DateTime @db.Date // ç­¾åˆ°æ—¥æœŸ
  dayOfMonth        Int      // å½“æœˆç¬¬å‡ å¤©(1-31)
  consecutiveDays   Int      // è¿ç»­ç­¾åˆ°å¤©æ•°
  pointsEarned      Int      // æœ¬æ¬¡è·å¾—ç§¯åˆ†
  monthlyTotal      Int      // æœ¬æœˆç´¯è®¡ç§¯åˆ†
  
  createdAt         DateTime @default(now())
  
  @@unique([userId, signInDate])
  @@index([userId])
  @@index([signInDate])
}
```

#### 1.5 favorites - æŠ€å¸ˆæ”¶è—è¡¨

```prisma
model Favorite {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([userId, therapistId])
  @@index([userId])
  @@index([therapistId])
}
```

#### 1.6 contact_unlocks - è”ç³»æ–¹å¼è§£é”è®°å½•è¡¨

```prisma
model ContactUnlock {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  cost        Int       @default(99) // èŠ±è´¹ç§¯åˆ†(é»˜è®¤99)
  unlockAt    DateTime  @default(now())
  
  @@unique([userId, therapistId])
  @@index([userId])
  @@index([therapistId])
}
```

#### 1.7 user_earnings - ç”¨æˆ·æ¨èæ”¶ç›Šè¡¨

```prisma
model UserEarning {
  id            String         @id @default(cuid())
  userId        String         // æ”¶ç›ŠäººID
  fromUserId    String         // è¢«æ¨èç”¨æˆ·ID
  orderId       String         // è®¢å•ID
  order         Order          @relation(fields: [orderId], references: [id])
  
  amount        Decimal        @db.Decimal(10, 2) // æ”¶ç›Šé‡‘é¢(è®¢å•æ€»é¢10%)
  status        EarningStatus  @default(PENDING)
  
  createdAt     DateTime       @default(now())
  settledAt     DateTime?      // ç»“ç®—æ—¶é—´
  
  @@index([userId])
  @@index([orderId])
  @@index([status])
}

enum EarningStatus {
  PENDING   // å¾…ç»“ç®—
  SETTLED   // å·²ç»“ç®—
  WITHDRAWN // å·²æç°
}
```

---

### äºŒã€æŠ€å¸ˆç›¸å…³è¡¨ (7å¼ )

#### 2.1 therapists - æŠ€å¸ˆè¡¨ (æ ¸å¿ƒ)

```prisma
model Therapist {
  id                String          @id @default(cuid())
  phone             String          @unique // æ‰‹æœºå·
  password          String          // å¯†ç 
  nickname          String          // æ˜µç§°/è‰ºå
  
  // åŸºæœ¬ä¿¡æ¯
  age               Int             // å¹´é¾„
  height            Int             // èº«é«˜(cm)
  weight            Int             // ä½“é‡(kg)
  city              String          // æœåŠ¡åŸå¸‚
  areas             String[]        // æœåŠ¡åŒºåŸŸ(æ•°ç»„)
  
  // å®¡æ ¸çŠ¶æ€
  status            TherapistStatus @default(PENDING)
  auditReason       String?         // å®¡æ ¸ä¸é€šè¿‡åŸå› 
  
  // åœ¨çº¿çŠ¶æ€
  isOnline          Boolean         @default(false)
  lastOnlineAt      DateTime?
  
  // æ ‡ç­¾
  isNew             Boolean         @default(true)  // æ–°æŠ€å¸ˆ(æ³¨å†Œ30å¤©å†…)
  isFeatured        Boolean         @default(false) // æ¨èæŠ€å¸ˆ
  
  // é‚€è¯·ç 
  inviteCode        String          @unique // æŠ€å¸ˆé‚€è¯·ç (8ä½)
  invitedBy         String?         // é‚€è¯·äººé‚€è¯·ç 
  inviter           Therapist?      @relation("TherapistInvitations", fields: [invitedBy], references: [inviteCode])
  invitees          Therapist[]     @relation("TherapistInvitations")
  
  // ç»Ÿè®¡æ•°æ®
  totalOrders       Int             @default(0) // æ€»æ¥å•æ•°
  acceptedOrders    Int             @default(0) // å·²æ¥å•æ•°
  rejectedOrders    Int             @default(0) // æ‹’å•æ•°
  completedOrders   Int             @default(0) // å®Œæˆè®¢å•æ•°
  totalEarnings     Decimal         @default(0) @db.Decimal(10, 2) // ç´¯è®¡æ”¶ç›Š
  withdrawableBalance Decimal       @default(0) @db.Decimal(10, 2) // å¯æç°ä½™é¢
  
  // è¯„åˆ†
  rating            Decimal?        @db.Decimal(3, 2) // å¹³å‡è¯„åˆ†(0-5)
  reviewCount       Int             @default(0) // è¯„ä»·æ•°
  
  // æ—¶é—´æˆ³
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  auditedAt         DateTime?       // å®¡æ ¸æ—¶é—´
  
  // å…³è”
  profile           TherapistProfile?
  photos            TherapistPhoto[]
  videos            TherapistVideo[]
  schedules         TherapistSchedule[]
  orders            Order[]
  reviews           Review[]
  favorites         Favorite[]
  unlocks           ContactUnlock[]
  earnings          TherapistEarning[]
  
  @@index([phone])
  @@index([status])
  @@index([city])
  @@index([isOnline])
  @@index([createdAt])
}

enum TherapistStatus {
  PENDING   // å¾…å®¡æ ¸
  APPROVED  // å·²é€šè¿‡
  REJECTED  // å·²æ‹’ç»
  BANNED    // å·²å°ç¦
}
```

#### 2.2 therapist_profiles - æŠ€å¸ˆèµ„æ–™è¡¨

```prisma
model TherapistProfile {
  id              String    @id @default(cuid())
  therapistId     String    @unique
  therapist       Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  introduction    String    @db.Text // ä¸ªäººä»‹ç»
  specialties     String[]  // æœåŠ¡ç‰¹è‰²(æ•°ç»„)
  
  // è”ç³»æ–¹å¼(åŠ å¯†å­˜å‚¨)
  wechat          String?   // å¾®ä¿¡å·
  qq              String?   // QQå·
  
  // æœåŠ¡æ–¹å¼
  serviceType     ServiceType[] // æœåŠ¡æ–¹å¼(å¤šé€‰)
  serviceAddress  String?   // æœåŠ¡åœ°å€
  serviceLat      Decimal?  @db.Decimal(10, 7) // çº¬åº¦
  serviceLng      Decimal?  @db.Decimal(10, 7) // ç»åº¦
  serviceRadius   Int?      // æœåŠ¡åŠå¾„(km)
  
  // é“¶è¡Œä¿¡æ¯(æç°ç”¨)
  realName        String?   // çœŸå®å§“å
  bankName        String?   // é“¶è¡Œåç§°
  bankAccount     String?   // é“¶è¡Œè´¦å·(åŠ å¯†)
  alipay          String?   // æ”¯ä»˜å®è´¦å·
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([therapistId])
}

enum ServiceType {
  VISIT_CLIENT   // ä¸Šé—¨æœåŠ¡
  CLIENT_VISIT   // å®¢æˆ·åˆ°åº—
  NEGOTIATE      // åŒæ–¹åå•†
}
```

#### 2.3 therapist_photos - æŠ€å¸ˆç…§ç‰‡è¡¨

```prisma
model TherapistPhoto {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  url         String    // å›¾ç‰‡URL
  order       Int       @default(0) // æ’åº(æ•°å­—è¶Šå°è¶Šé å‰)
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
  @@index([order])
}
```

#### 2.4 therapist_videos - æŠ€å¸ˆè§†é¢‘è¡¨

```prisma
model TherapistVideo {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  url         String    // è§†é¢‘URL
  coverUrl    String?   // å°é¢å›¾URL
  duration    Int?      // æ—¶é•¿(ç§’)
  
  createdAt   DateTime  @default(now())
  
  @@index([therapistId])
}
```

#### 2.5 therapist_schedules - æŠ€å¸ˆæ—¶é—´è¡¨

```prisma
model TherapistSchedule {
  id          String    @id @default(cuid())
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  date        DateTime  @db.Date // æ—¥æœŸ
  startTime   String    // å¼€å§‹æ—¶é—´(HH:mm)
  endTime     String    // ç»“æŸæ—¶é—´(HH:mm)
  
  isAvailable Boolean   @default(true) // æ˜¯å¦å¯ç”¨
  isRecurring Boolean   @default(false) // æ˜¯å¦é‡å¤(æ¯å¤©)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([therapistId, date, startTime])
  @@index([therapistId])
  @@index([date])
}
```

#### 2.6 therapist_earnings - æŠ€å¸ˆæ¨èæ”¶ç›Šè¡¨

```prisma
model TherapistEarning {
  id              String         @id @default(cuid())
  therapistId     String         // æ”¶ç›ŠäººID
  fromTherapistId String         // è¢«æ¨èæŠ€å¸ˆID
  orderId         String         // è®¢å•ID
  order           Order          @relation(fields: [orderId], references: [id])
  
  amount          Decimal        @db.Decimal(10, 2) // æ”¶ç›Šé‡‘é¢(è®¢å•æ€»é¢5%)
  status          EarningStatus  @default(PENDING)
  
  createdAt       DateTime       @default(now())
  settledAt       DateTime?
  
  @@index([therapistId])
  @@index([orderId])
  @@index([status])
}
```

#### 2.7 withdrawals - æç°è®°å½•è¡¨

```prisma
model Withdrawal {
  id            String           @id @default(cuid())
  therapistId   String
  therapist     Therapist        @relation(fields: [therapistId], references: [id])
  
  amount        Decimal          @db.Decimal(10, 2) // æç°é‡‘é¢
  fee           Decimal          @default(0) @db.Decimal(10, 2) // æ‰‹ç»­è´¹
  actualAmount  Decimal          @db.Decimal(10, 2) // å®é™…åˆ°è´¦
  
  method        WithdrawMethod   // æç°æ–¹å¼
  account       String           // æ”¶æ¬¾è´¦å·
  accountName   String           // æ”¶æ¬¾äºº
  
  status        WithdrawStatus   @default(PENDING)
  rejectReason  String?          // æ‹’ç»åŸå› 
  
  appliedAt     DateTime         @default(now())
  processedAt   DateTime?        // å¤„ç†æ—¶é—´
  completedAt   DateTime?        // å®Œæˆæ—¶é—´
  
  processedBy   String?          // å¤„ç†äºº(ç®¡ç†å‘˜ID)
  
  @@index([therapistId])
  @@index([status])
  @@index([appliedAt])
}

enum WithdrawMethod {
  ALIPAY  // æ”¯ä»˜å®
  WECHAT  // å¾®ä¿¡
  BANK    // é“¶è¡Œå¡
}

enum WithdrawStatus {
  PENDING    // å¾…å®¡æ ¸
  PROCESSING // å¤„ç†ä¸­
  COMPLETED  // å·²å®Œæˆ
  REJECTED   // å·²æ‹’ç»
}
```

---

### ä¸‰ã€è®¢å•ç›¸å…³è¡¨ (4å¼ )

#### 3.1 orders - è®¢å•è¡¨ (æ ¸å¿ƒ)

```prisma
model Order {
  id            String       @id @default(cuid())
  orderNo       String       @unique // è®¢å•å·(è‡ªåŠ¨ç”Ÿæˆ)
  
  // ç”¨æˆ·ä¿¡æ¯
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  
  // æŠ€å¸ˆä¿¡æ¯
  therapistId   String
  therapist     Therapist    @relation(fields: [therapistId], references: [id])
  
  // æœåŠ¡ä¿¡æ¯
  serviceId     String
  service       Service      @relation(fields: [serviceId], references: [id])
  
  // é¢„çº¦ä¿¡æ¯
  appointmentDate DateTime   @db.Date // é¢„çº¦æ—¥æœŸ
  appointmentTime String     // é¢„çº¦æ—¶é—´(HH:mm)
  serviceType     ServiceType // æœåŠ¡æ–¹å¼
  address         String     // æœåŠ¡åœ°å€
  addressLat      Decimal?   @db.Decimal(10, 7) // çº¬åº¦
  addressLng      Decimal?   @db.Decimal(10, 7) // ç»åº¦
  
  // è”ç³»ä¿¡æ¯
  customerName    String     // å®¢æˆ·å§“å
  customerPhone   String     // å®¢æˆ·ç”µè¯
  
  // é‡‘é¢ä¿¡æ¯
  totalAmount     Decimal    @db.Decimal(10, 2) // è®¢å•æ€»é¢
  depositAmount   Decimal    @db.Decimal(10, 2) // å®šé‡‘é‡‘é¢(50%)
  balanceAmount   Decimal    @db.Decimal(10, 2) // å°¾æ¬¾é‡‘é¢(50%)
  
  // ç§¯åˆ†æŠµæ‰£
  formalPointsUsed Int       @default(0) // ä½¿ç”¨æ­£å¼ç§¯åˆ†
  tempPointsUsed   Int       @default(0) // ä½¿ç”¨ä¸´æ—¶ç§¯åˆ†
  pointsDiscount   Decimal   @default(0) @db.Decimal(10, 2) // ç§¯åˆ†æŠµæ‰£é‡‘é¢
  
  // å®é™…æ”¯ä»˜
  actualPaid       Decimal   @db.Decimal(10, 2) // å®é™…æ”¯ä»˜é‡‘é¢
  
  // è®¢å•çŠ¶æ€
  status           OrderStatus @default(PENDING_PAYMENT)
  
  // æ”¯ä»˜ä¿¡æ¯
  paymentMethod    String?    // æ”¯ä»˜æ–¹å¼(semipay)
  paymentTime      DateTime?  // æ”¯ä»˜æ—¶é—´
  paymentNo        String?    // æ”¯ä»˜æµæ°´å·
  
  // æ¥å•ä¿¡æ¯
  acceptedAt       DateTime?  // æ¥å•æ—¶é—´
  rejectedAt       DateTime?  // æ‹’å•æ—¶é—´
  rejectReason     String?    // æ‹’å•åŸå› 
  
  // å®Œæˆä¿¡æ¯
  completedAt      DateTime?  // å®Œæˆæ—¶é—´
  
  // ç‰¹æ®Šå¤‡æ³¨
  remarks          String?    @db.Text // ç”¨æˆ·å¤‡æ³¨
  
  // æ”¿ç­–ç¡®è®¤
  policyAgreed     Boolean    @default(false) // æ˜¯å¦åŒæ„"åªæ¢ä¸é€€"æ”¿ç­–
  
  // æ—¶é—´æˆ³
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  
  // å…³è”
  statusLogs       OrderStatusLog[]
  review           Review?
  userEarnings     UserEarning[]
  therapistEarnings TherapistEarning[]
  
  @@index([orderNo])
  @@index([userId])
  @@index([therapistId])
  @@index([status])
  @@index([createdAt])
  @@index([appointmentDate])
}

enum OrderStatus {
  PENDING_PAYMENT  // å¾…æ”¯ä»˜
  PENDING_ACCEPT   // å¾…æ¥å•
  ACCEPTED         // å·²æ¥å•
  IN_SERVICE       // æœåŠ¡ä¸­
  COMPLETED        // å·²å®Œæˆ
  REVIEWED         // å·²è¯„ä»·
  REJECTED         // å·²æ‹’å•
  REFUNDED         // å·²é€€æ¬¾(ç§¯åˆ†)
  CANCELLED        // å·²å–æ¶ˆ
}
```

#### 3.2 order_status_logs - è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—è¡¨

```prisma
model OrderStatusLog {
  id          String      @id @default(cuid())
  orderId     String
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  fromStatus  OrderStatus? // åŸçŠ¶æ€
  toStatus    OrderStatus  // æ–°çŠ¶æ€
  
  operator    String?     // æ“ä½œäºº(ç”¨æˆ·/æŠ€å¸ˆ/ç³»ç»Ÿ/ç®¡ç†å‘˜)
  operatorType String?    // æ“ä½œäººç±»å‹
  reason      String?     // åŸå› /å¤‡æ³¨
  
  createdAt   DateTime    @default(now())
  
  @@index([orderId])
  @@index([createdAt])
}
```

#### 3.3 reviews - è®¢å•è¯„ä»·è¡¨

```prisma
model Review {
  id          String   @id @default(cuid())
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  therapistId String
  therapist   Therapist @relation(fields: [therapistId], references: [id])
  
  rating      Int      // è¯„åˆ†(1-5æ˜Ÿ)
  content     String?  @db.Text // è¯„ä»·å†…å®¹(å¯é€‰)
  
  // å®¡æ ¸çŠ¶æ€
  isApproved  Boolean  @default(false) // æ˜¯å¦é€šè¿‡å®¡æ ¸
  isVisible   Boolean  @default(false) // æ˜¯å¦æ˜¾ç¤º
  
  createdAt   DateTime @default(now())
  approvedAt  DateTime? // å®¡æ ¸é€šè¿‡æ—¶é—´
  approvedBy  String?  // å®¡æ ¸äºº(ç®¡ç†å‘˜ID)
  
  @@index([orderId])
  @@index([userId])
  @@index([therapistId])
  @@index([isVisible])
}
```

#### 3.4 complaints - æŠ•è¯‰ç”³è¯‰è¡¨

```prisma
model Complaint {
  id            String          @id @default(cuid())
  orderId       String
  
  complainant   String          // æŠ•è¯‰äººID
  complainantType String        // æŠ•è¯‰äººç±»å‹(user/therapist)
  
  reason        String          @db.Text // æŠ•è¯‰åŸå› 
  evidence      String[]        // è¯æ®(å›¾ç‰‡URLs)
  
  status        ComplaintStatus @default(PENDING)
  result        String?         @db.Text // å¤„ç†ç»“æœ
  
  createdAt     DateTime        @default(now())
  processedAt   DateTime?
  processedBy   String?         // å¤„ç†äºº(ç®¡ç†å‘˜ID)
  
  @@index([orderId])
  @@index([status])
}

enum ComplaintStatus {
  PENDING    // å¾…å¤„ç†
  PROCESSING // å¤„ç†ä¸­
  RESOLVED   // å·²è§£å†³
  REJECTED   // å·²é©³å›
}
```

---

### å››ã€æœåŠ¡ç›¸å…³è¡¨ (3å¼ )

#### 4.1 services - æœåŠ¡é¡¹ç›®è¡¨

```prisma
model Service {
  id          String   @id @default(cuid())
  name        String   // æœåŠ¡åç§°
  description String   @db.Text // æœåŠ¡æè¿°
  price       Decimal  @db.Decimal(10, 2) // ä»·æ ¼
  duration    Int      // æœåŠ¡æ—¶é•¿(åˆ†é’Ÿ)
  
  features    String[] // æœåŠ¡ç‰¹è‰²(æ•°ç»„)
  
  order       Int      @default(0) // æ’åº
  isActive    Boolean  @default(true) // æ˜¯å¦å¯ç”¨
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  orders      Order[]
  
  @@index([isActive])
  @@index([order])
}
```

#### 4.2 cities - åŸå¸‚è¡¨

```prisma
model City {
  id          String   @id @default(cuid())
  name        String   @unique // åŸå¸‚åç§°
  province    String   // çœä»½
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  areas       Area[]
  
  @@index([isActive])
}
```

#### 4.3 areas - åŒºåŸŸè¡¨

```prisma
model Area {
  id          String   @id @default(cuid())
  cityId      String
  city        City     @relation(fields: [cityId], references: [id])
  
  name        String   // åŒºåŸŸåç§°
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  @@index([cityId])
  @@index([isActive])
}
```

---

### äº”ã€é‚€è¯·åˆ†ä½£è¡¨ (5å¼ )

#### 5.1 invitations - é‚€è¯·å…³ç³»è¡¨

```prisma
model Invitation {
  id            String   @id @default(cuid())
  inviteCode    String   @unique // é‚€è¯·ç 
  inviterType   String   // é‚€è¯·äººç±»å‹(user/therapist/agent)
  inviterId     String   // é‚€è¯·äººID
  
  inviteeType   String   // è¢«é‚€è¯·äººç±»å‹
  inviteeId     String   // è¢«é‚€è¯·äººID
  
  createdAt     DateTime @default(now())
  
  @@index([inviteCode])
  @@index([inviterId])
}
```

#### 5.2 agents - ä»£ç†å•†è¡¨

```prisma
model Agent {
  id            String   @id @default(cuid())
  name          String   // ä»£ç†å•†åç§°
  phone         String   @unique
  password      String
  
  inviteCode    String   @unique // ä»£ç†ä¸“å±é‚€è¯·ç 
  commissionRate Decimal @db.Decimal(5, 2) // ä½£é‡‘æ¯”ä¾‹(%)
  
  totalEarnings Decimal  @default(0) @db.Decimal(10, 2) // ç´¯è®¡æ”¶ç›Š
  withdrawableBalance Decimal @default(0) @db.Decimal(10, 2) // å¯æç°ä½™é¢
  
  status        AgentStatus @default(ACTIVE)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  earnings      AgentEarning[]
  
  @@index([inviteCode])
}

enum AgentStatus {
  ACTIVE
  SUSPENDED
  BANNED
}
```

#### 5.3 agent_earnings - ä»£ç†æ”¶ç›Šè¡¨

```prisma
model AgentEarning {
  id          String         @id @default(cuid())
  agentId     String
  agent       Agent          @relation(fields: [agentId], references: [id])
  
  orderId     String         // å…³è”è®¢å•
  amount      Decimal        @db.Decimal(10, 2) // æ”¶ç›Šé‡‘é¢
  
  status      EarningStatus  @default(PENDING)
  
  createdAt   DateTime       @default(now())
  settledAt   DateTime?
  
  @@index([agentId])
}
```

#### 5.4 referral_configs - åˆ†ä½£é…ç½®è¡¨

```prisma
model ReferralConfig {
  id                    String   @id @default(cuid())
  
  userReferralRate      Decimal  @db.Decimal(5, 2) // ç”¨æˆ·æ¨èä½£é‡‘æ¯”ä¾‹(é»˜è®¤10%)
  therapistReferralRate Decimal  @db.Decimal(5, 2) // æŠ€å¸ˆæ¨èä½£é‡‘æ¯”ä¾‹(é»˜è®¤5%)
  
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // æ›´æ–°äºº(ç®¡ç†å‘˜ID)
}
```

#### 5.5 transactions - äº¤æ˜“æµæ°´è¡¨

```prisma
model Transaction {
  id            String          @id @default(cuid())
  transactionNo String          @unique // æµæ°´å·
  
  type          TransactionType // äº¤æ˜“ç±»å‹
  relatedId     String?         // å…³è”ID(è®¢å•/æç°)
  
  userId        String?         // ç”¨æˆ·ID
  therapistId   String?         // æŠ€å¸ˆID
  agentId       String?         // ä»£ç†ID
  
  amount        Decimal         @db.Decimal(10, 2) // é‡‘é¢
  balance       Decimal         @db.Decimal(10, 2) // å˜åŠ¨åä½™é¢
  
  description   String?         // æè¿°
  
  createdAt     DateTime        @default(now())
  
  @@index([userId])
  @@index([therapistId])
  @@index([type])
  @@index([createdAt])
}

enum TransactionType {
  ORDER_DEPOSIT      // è®¢å•å®šé‡‘
  ORDER_REFUND       // è®¢å•é€€æ¬¾
  REFERRAL_REWARD    // æ¨èå¥–åŠ±
  WITHDRAWAL         // æç°
  ADMIN_ADJUSTMENT   // ç®¡ç†å‘˜è°ƒæ•´
}
```

---

### å…­ã€ç³»ç»Ÿç›¸å…³è¡¨ (5å¼ )

#### 6.1 admin_users - ç®¡ç†å‘˜è¡¨

```prisma
model AdminUser {
  id          String     @id @default(cuid())
  username    String     @unique
  password    String
  realName    String?
  
  role        AdminRole  @default(OPERATOR)
  permissions String[]   // æƒé™åˆ—è¡¨(æ•°ç»„)
  
  status      Boolean    @default(true) // æ˜¯å¦å¯ç”¨
  
  lastLoginAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([username])
}

enum AdminRole {
  SUPER_ADMIN  // è¶…çº§ç®¡ç†å‘˜
  ADMIN        // ç®¡ç†å‘˜
  OPERATOR     // è¿è¥
  CUSTOMER_SERVICE // å®¢æœ
}
```

#### 6.2 notifications - é€šçŸ¥æ¶ˆæ¯è¡¨

```prisma
model Notification {
  id          String           @id @default(cuid())
  userId      String?
  user        User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  content     String           @db.Text
  
  relatedId   String?          // å…³è”ID(è®¢å•/æç°)
  
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  SYSTEM       // ç³»ç»Ÿé€šçŸ¥
  ORDER        // è®¢å•é€šçŸ¥
  PAYMENT      // æ”¯ä»˜é€šçŸ¥
  REVIEW       // è¯„ä»·é€šçŸ¥
  WITHDRAWAL   // æç°é€šçŸ¥
  PROMOTION    // æ¨å¹¿é€šçŸ¥
}
```

#### 6.3 announcements - å…¬å‘Šè¡¨

```prisma
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  
  target      String[] // ç›®æ ‡å—ä¼—(user/therapist/all)
  
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  createdBy   String?  // åˆ›å»ºäºº(ç®¡ç†å‘˜ID)
  
  @@index([isActive])
  @@index([order])
}
```

#### 6.4 feedbacks - ç•™è¨€åé¦ˆè¡¨

```prisma
model Feedback {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  
  content     String         @db.Text // ç•™è¨€å†…å®¹
  
  reply       String?        @db.Text // å›å¤å†…å®¹
  repliedAt   DateTime?
  repliedBy   String?        // å›å¤äºº(ç®¡ç†å‘˜ID)
  
  status      FeedbackStatus @default(PENDING)
  
  createdAt   DateTime       @default(now())
  
  @@index([userId])
  @@index([status])
}

enum FeedbackStatus {
  PENDING  // å¾…å¤„ç†
  REPLIED  // å·²å›å¤
  CLOSED   // å·²å…³é—­
}
```

#### 6.5 system_configs - ç³»ç»Ÿé…ç½®è¡¨

```prisma
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique // é…ç½®é”®
  value       String   @db.Text // é…ç½®å€¼(JSON)
  description String?  // æè¿°
  
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // æ›´æ–°äºº(ç®¡ç†å‘˜ID)
  
  @@index([key])
}
```

---

## ğŸ”— è¡¨å…³ç³»å›¾

```
ç”¨æˆ·ç³»ç»Ÿï¼š
User â”€â”€< UserProfile
User â”€â”€< PointRecord
User â”€â”€< SignInRecord
User â”€â”€< Favorite >â”€â”€ Therapist
User â”€â”€< ContactUnlock >â”€â”€ Therapist
User â”€â”€< Order

æŠ€å¸ˆç³»ç»Ÿï¼š
Therapist â”€â”€< TherapistProfile
Therapist â”€â”€< TherapistPhoto
Therapist â”€â”€< TherapistVideo
Therapist â”€â”€< TherapistSchedule
Therapist â”€â”€< Order

è®¢å•ç³»ç»Ÿï¼š
Order >â”€â”€ User
Order >â”€â”€ Therapist
Order >â”€â”€ Service
Order â”€â”€< OrderStatusLog
Order â”€â”€â—‹ Review (ä¸€å¯¹ä¸€)

é‚€è¯·åˆ†ä½£ï¼š
User >â”€â”€ User (è‡ªå…³è”)
Therapist >â”€â”€ Therapist (è‡ªå…³è”)
Agent â”€â”€< AgentEarning

ç³»ç»Ÿï¼š
User â”€â”€< Notification
User â”€â”€< Feedback
```

**ç¬¦å·è¯´æ˜**ï¼š
- `â”€â”€<` : ä¸€å¯¹å¤š
- `>â”€â”€` : å¤šå¯¹ä¸€
- `â”€â”€â—‹` : ä¸€å¯¹ä¸€
- `>â”€â”€<` : å¤šå¯¹å¤š

---

## ğŸ“‡ ç´¢å¼•è®¾è®¡

### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

```sql
-- ç”¨æˆ·è¡¨
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_invite_code ON users(invite_code);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- æŠ€å¸ˆè¡¨
CREATE INDEX idx_therapists_phone ON therapists(phone);
CREATE INDEX idx_therapists_status ON therapists(status);
CREATE INDEX idx_therapists_city ON therapists(city);
CREATE INDEX idx_therapists_online ON therapists(is_online);
CREATE INDEX idx_therapists_rating ON therapists(rating);

-- è®¢å•è¡¨
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_therapist_id ON orders(therapist_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_appointment_date ON orders(appointment_date);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_therapist_status ON orders(therapist_id, status);
CREATE INDEX idx_sign_in_user_date ON sign_in_records(user_id, sign_in_date);
```

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡éœ€æ±‚

### ç®¡ç†ç«¯æ•°æ®çœ‹æ¿SQLè§†å›¾

```sql
-- ä»Šæ—¥æ•°æ®ç»Ÿè®¡
CREATE VIEW daily_stats AS
SELECT
  DATE(created_at) as date,
  COUNT(DISTINCT user_id) as new_users,
  COUNT(*) as total_orders,
  SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_orders,
  SUM(CASE WHEN status = 'COMPLETED' THEN actual_paid ELSE 0 END) as gmv
FROM orders
GROUP BY DATE(created_at);

-- æŠ€å¸ˆç»©æ•ˆç»Ÿè®¡
CREATE VIEW therapist_performance AS
SELECT
  therapist_id,
  COUNT(*) as total_orders,
  SUM(CASE WHEN status = 'ACCEPTED' THEN 1 ELSE 0 END) as accepted_orders,
  SUM(CASE WHEN status = 'REJECTED' THEN 1 ELSE 0 END) as rejected_orders,
  ROUND(SUM(CASE WHEN status = 'ACCEPTED' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as accept_rate,
  AVG(rating) as avg_rating
FROM orders
LEFT JOIN reviews ON orders.id = reviews.order_id
GROUP BY therapist_id;
```

---

## ğŸ” å®‰å…¨ä¸å¤‡ä»½

### æ•æ„Ÿå­—æ®µåŠ å¯†
- `users.password` - bcryptåŠ å¯†
- `therapists.password` - bcryptåŠ å¯†
- `admin_users.password` - bcryptåŠ å¯†
- `user_profiles.id_card` - AESåŠ å¯†
- `therapist_profiles.bank_account` - AESåŠ å¯†

### å¤‡ä»½ç­–ç•¥
- æ¯æ—¥å…¨é‡å¤‡ä»½: å‡Œæ™¨3ç‚¹
- æ¯å°æ—¶å¢é‡å¤‡ä»½
- ä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½
- æ¯å‘¨å¤‡ä»½ä¸Šä¼ åˆ°äº‘å­˜å‚¨

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| v1.0 | 2025-10-08 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´æ•°æ®åº“è®¾è®¡ |

---

**æ–‡æ¡£ç»“æŸ**

